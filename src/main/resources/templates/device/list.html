<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, viewport-fit=cover">
    <title>장비 목록</title>
    <link rel="stylesheet" href="/device.css" />
    <link rel="stylesheet" href="/main.css" />
    <link rel="stylesheet" href="/navbar.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        
        .alert-dismissible {
            position: relative;
        }
        
        .btn-close {
            position: absolute;
            top: 0;
            right: 0;
            z-index: 2;
            padding: 15px;
            background: transparent;
            border: 0;
            font-size: 20px;
            cursor: pointer;
            color: #155724;
        }
        
        .btn-close:hover {
            color: #0f5132;
        }
        
        /* 주황색 버튼 스타일 */
        .btn-orange {
            background-color: #ff8c00;
            border-color: #ff8c00;
            color: white;
        }
        
        .btn-orange:hover {
            background-color: #e67e00;
            border-color: #e67e00;
            color: white;
        }
        
        .btn-orange:focus {
            background-color: #e67e00;
            border-color: #e67e00;
            color: white;
            box-shadow: 0 0 0 0.2rem rgba(255, 140, 0, 0.25);
        }
        
        .alert i {
            margin-right: 8px;
        }
        
        /* 필터 컨테이너 스타일 - 1줄: 필터, 2줄: 버튼 */
        .filter-container {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .filter-container form {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .action-buttons-container {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 10px !important;
            flex-wrap: wrap !important;
            width: 100% !important;
            margin-left: 0 !important;
        }
        
        .filter-form-grid {
            display: contents;
        }
        .filter-select {
            width: 15.3% !important; /* 기존 18%에서 15% 감소 (18% * 0.85) */
        }
        
        /* 필터 체크박스 그룹 (용도, 불용) */
        .filter-checkbox-group {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-left: 8px;
            padding: 6px 14px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        }
        
        .filter-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
            font-size: 14px;
            font-weight: 500;
            color: #475569;
            padding: 4px 0;
        }
        
        .filter-checkbox-item:hover {
            color: #1e293b;
        }
        
        .filter-checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #3b82f6;
            border-radius: 5px;
        }
        
        .filter-checkbox-item.unused-item input[type="checkbox"] {
            accent-color: #f59e0b;
        }
        
        .filter-checkbox-item span {
            white-space: nowrap;
        }
        
        .purpose-sort-checkbox {
            display: flex;
            align-items: center;
            margin-left: 5px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
            font-size: 14px;
            color: #333;
        }
        
        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-label span {
            white-space: nowrap;
        }
        
        /* 검색 기능 스타일 */
        .search-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            padding: 0 20px;
        }
        
        .search-form {
            width: 100%;
            max-width: 600px;
        }
        
        .search-input-group {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .search-input-group:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        
        .search-input {
            flex: 1;
            padding: 15px 20px;
            border: none;
            outline: none;
            font-size: 16px;
            background: transparent;
        }
        
        .search-input::placeholder {
            color: #999;
            font-style: italic;
        }
        
        .search-btn {
            padding: 15px 20px;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 16px;
        }
        
        .search-btn:hover {
            background: #0056b3;
        }
        
        .search-btn i {
            font-size: 18px;
        }
        
        /* QR 스캔 버튼 (검색 버튼 옆) */
        .qr-scan-btn {
            padding: 15px 18px;
            background: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 16px;
            border-left: 1px solid rgba(255,255,255,0.2);
        }
        .qr-scan-btn:hover {
            background: #218838;
        }
        .qr-scan-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .qr-scan-btn i {
            font-size: 18px;
        }
        /* QR 스캔 모달 */
        #qrScanModal {
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }
        #qrScanModal.show {
            display: flex;
        }
        .qr-scan-modal-content {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            max-width: 95%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .qr-scan-modal-content video {
            width: 100%;
            max-width: 400px;
            border-radius: 8px;
            background: #000;
        }
        .qr-scan-modal-content canvas {
            display: none;
        }
        .qr-scan-modal-content .qr-scan-msg {
            margin: 12px 0;
            font-size: 14px;
            color: #555;
        }
        .qr-scan-modal-content .qr-scan-close {
            margin-top: 12px;
            padding: 10px 24px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        .qr-scan-modal-content .qr-scan-close:hover {
            background: #5a6268;
        }
        
        /* 검색 키워드 강조 표시 스타일 */
        .search-highlight {
            background-color: transparent;
            color: #d32f2f;
            font-weight: bold;
            text-shadow: 0 0 1px rgba(255, 255, 255, 0.8);
        }
        
        .search-highlight:hover {
            color: #b71c1c;
            text-shadow: 0 0 2px rgba(255, 255, 255, 0.9);
            transition: all 0.2s ease;
        }
        
        /* 학교 선택 안내 메시지 스타일 */
        .school-selection-message {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin: 30px 0;
        }
        
        .message-container {
            text-align: center;
            padding: 40px;
        }
        
        .message-container i {
            font-size: 4rem;
            color: #6b7280;
            margin-bottom: 20px;
        }
        
        .message-container h3 {
            font-size: 1.5rem;
            color: #374151;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .message-container p {
            font-size: 1rem;
            color: #6b7280;
            margin: 0;
        }
        
        /* 검사모드 관련 스타일 */
        .inspection-checkbox {
            cursor: pointer;
            text-align: center;
            padding: 5px;
        }
        
        .inspection-icon {
            font-size: 20px;
            transition: color 0.2s ease;
        }
        
        /* 모바일 검사확인 체크박스 스타일 */
        .inspection-checkbox-mobile {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #f3f4f6 !important;
            border: 2px solid #e5e7eb !important;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease !important;
            height: 38px; /* 버튼 높이와 맞춤 */
            box-sizing: border-box;
        }
        
        .inspection-checkbox-mobile.state-unchecked {
            background: #f3f4f6 !important;
            border-color: #e5e7eb !important;
        }
        
        .inspection-checkbox-mobile.state-confirmed {
            background: #e8f5e9 !important;
            border-color: #28a745 !important;
        }
        
        .inspection-checkbox-mobile.state-modified {
            background: #fff7e6 !important;
            border-color: #ffc107 !important;
        }
        
        .inspection-checkbox-mobile:hover {
            opacity: 0.9;
        }
        
        .inspection-checkbox-mobile .inspection-icon {
            font-size: 18px;
            transition: color 0.2s ease;
        }
        
        .inspection-checkbox-mobile .inspection-label {
            font-size: 14px;
            font-weight: 500;
            color: #495057;
        }
        
        .inspection-checkbox-mobile:hover .inspection-label {
            color: #1976d2;
        }
        
        /* 모바일 카드 액션 버튼들 정렬 - 수평·크기 통일 */
        .card-actions {
            display: flex;
            flex-direction: row;
            gap: 8px;
            align-items: stretch;
            justify-content: flex-start;
            flex-wrap: nowrap;
        }
        
        .card-actions .inspection-checkbox-mobile {
            flex: 1 1 0;
            min-width: 0;
            height: 38px;
            min-height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            box-sizing: border-box;
        }

        .card-actions .btn,
        .card-actions form {
            flex: 1 1 0;
            min-width: 0;
            height: 38px;
            min-height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }

        .card-actions form {
            margin: 0;
        }

        .card-actions form button.btn {
            width: 100%;
            min-height: 38px;
        }
        
        .inspection-icon.unchecked {
            color: #ccc !important;
        }
        
        .inspection-icon.confirmed {
            color: #28a745 !important;
        }
        
        .inspection-icon.modified {
            color: #ffc107 !important;
        }
        
        /* 검색 옵션 스타일 */
        .search-option {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            color: #333;
        }
        
        .search-option input[type="checkbox"] {
            margin-right: 5px;
        }
        
        /* 모달 스타일 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            background: #2563eb;
            color: #fff;
            padding: 1rem 1.25rem;
            text-align: center;
            border-radius: 20px 20px 0 0;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: #fff;
            word-break: keep-all;
        }
        
        .modal-body {
            padding: 2rem;
            overflow: visible;
        }
        
        .school-select {
            overflow: visible;
        }
        
        .school-search {
            margin-bottom: 1.5rem;
        }
        
        .school-search input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .school-search input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .school-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .school-item {
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .school-item:hover {
            background: #f8fafc;
            border-color: #3b82f6;
        }
        
        .school-item.selected {
            background: #dbeafe;
            border-color: #3b82f6;
        }
        
        .modal-footer {
            padding: 1.5rem 2rem;
            background: #f8fafc;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        
        .confirm-btn, .cancel-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .confirm-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .confirm-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        
        .cancel-btn {
            background: #6b7280;
            color: white;
        }
        
        .cancel-btn:hover {
            background: #4b5563;
        }
        
        .school-select {
            margin-bottom: 1rem;
            overflow: visible;
        }
        
        .school-select label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }
        
        .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            transition: border-color 0.3s ease;
        }
        #schoolSelectModal .form-select {
            position: relative;
            z-index: 10001;
        }
        
        /* 장비검사 모달 - 모바일 최적화 */
        @media (max-width: 768px) {
            .modal-overlay {
                box-sizing: border-box;
                left: 0;
                right: 0;
                width: 100%;
                padding-left: 16px;
                padding-right: 16px;
                padding-top: 16px;
                padding-bottom: max(16px, env(safe-area-inset-bottom));
                align-items: center;
                justify-content: center;
                overflow-x: hidden;
            }
            .modal-content {
                box-sizing: border-box;
                width: 100%;
                max-width: 360px;
                min-width: 0;
                max-height: 55vh;
                max-height: 55dvh;
                border-radius: 20px;
                margin: 0 auto;
                margin-left: auto;
                margin-right: auto;
                overflow: visible;
            }
            .modal-header {
                padding: 1rem 1.25rem;
                background: #2563eb;
                color: #fff;
            }
            .modal-header h2 {
                font-size: 1.25rem;
                word-break: keep-all;
                color: #fff;
            }
            .modal-body {
                padding: 1.25rem;
                overflow: visible;
                -webkit-overflow-scrolling: touch;
            }
            .school-select label {
                font-size: 0.95rem;
            }
            #schoolSelectModal .form-select,
            .modal-body .form-select {
                min-height: 44px;
                padding: 12px 14px;
                font-size: 16px;
                box-sizing: border-box;
            }
            .school-search input {
                min-height: 44px;
                padding: 12px 14px;
                font-size: 16px;
                box-sizing: border-box;
            }
            .school-list {
                max-height: 50vh;
            }
            .school-item {
                min-height: 44px;
                padding: 12px 1rem;
                display: flex;
                align-items: center;
                touch-action: manipulation;
            }
            .modal-footer {
                padding: 1rem 1.25rem;
                padding-bottom: max(1rem, env(safe-area-inset-bottom));
                flex-direction: row;
                gap: 10px;
                flex-wrap: nowrap;
            }
            .modal-footer .confirm-btn,
            .modal-footer .cancel-btn {
                flex: 1;
                min-width: 0;
                min-height: 44px;
                padding: 12px 1rem;
                font-size: 1rem;
                touch-action: manipulation;
            }
            /* 모바일: 네이티브 셀렉트 숨김, 커스텀 드롭다운 표시 */
            #schoolSelectModal .school-select-native {
                display: none !important;
            }
            #schoolSelectModal .school-select-custom {
                display: block !important;
            }
        }
        
        /* 데스크톱: 커스텀 드롭다운 숨김 */
        @media (min-width: 769px) {
            #schoolSelectModal .school-select-custom {
                display: none !important;
            }
        }
        
        /* 학교 선택 커스텀 드롭다운 (모바일 스크롤 가능) */
        .school-select-custom {
            display: none;
            position: relative;
        }
        .school-select-trigger {
            width: 100%;
            min-height: 44px;
            padding: 12px 14px;
            font-size: 16px;
            text-align: left;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: white;
            color: #374151;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            box-sizing: border-box;
            touch-action: manipulation;
        }
        .school-select-trigger:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .school-select-trigger .fa-chevron-down {
            font-size: 0.75rem;
            color: #6b7280;
            transition: transform 0.2s;
        }
        .school-select-custom.open .school-select-trigger .fa-chevron-down {
            transform: rotate(180deg);
        }
        .school-select-trigger-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .school-select-options {
            display: none;
            position: absolute;
            left: 0;
            right: 0;
            top: 100%;
            margin-top: 4px;
            max-height: 42vh;
            max-height: 42dvh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            z-index: 10002;
        }
        .school-select-custom.open .school-select-options {
            display: block;
        }
        .school-select-option {
            padding: 12px 14px;
            font-size: 16px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            touch-action: manipulation;
        }
        .school-select-option:last-child {
            border-bottom: none;
        }
        .school-select-option:hover,
        .school-select-option:focus {
            background: #eff6ff;
        }
        .school-select-option.selected {
            background: #dbeafe;
            color: #1d4ed8;
        }
        
        .search-option {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.9rem;
            color: #374151;
            transition: all 0.3s ease;
            padding: 8px 12px;
            border-radius: 8px;
            background: #f8fafc;
            border: 2px solid #e5e7eb;
        }
        
        .search-option:hover {
            background: #e0f2fe;
            border-color: #0ea5e9;
            color: #0c4a6e;
        }
        
        .search-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin: 0 5px;
        }
        
        .search-option:hover {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-color: #2196f3;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(33, 150, 243, 0.15);
        }
        
        .search-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #2196f3;
            cursor: pointer;
            transform: scale(1.1);
            margin: 0;
        }
        
        .search-option span {
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            cursor: pointer;
            user-select: none;
            transition: all 0.3s ease;
        }
        
        .search-option:hover span {
            color: #1976d2;
        }
        
        .search-option input[type="checkbox"]:checked + span {
            font-weight: 600;
            color: #1976d2;
        }
        
        /* 모바일 반응형 스타일 */
        @media (max-width: 768px) {
            .main, .content-wrapper {
                padding-left: env(safe-area-inset-left, 0);
                padding-right: env(safe-area-inset-right, 0);
                padding-bottom: env(safe-area-inset-bottom, 0);
            }
            .filter-container form {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            .filter-form-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            .filter-form-grid .filter-select {
                width: 100% !important;
                min-height: 44px;
                font-size: 16px;
            }
            .filter-form-grid .filter-checkbox-group {
                margin-left: 0;
                width: 100%;
                justify-content: flex-start;
                padding: 10px 14px;
                grid-column: span 1;
            }
            .filter-checkbox-item input[type="checkbox"] {
                width: 22px;
                height: 22px;
                min-width: 22px;
                min-height: 22px;
            }
            .action-buttons-container .btn,
            .action-buttons-container a.btn {
                min-height: 44px;
                padding: 10px 14px;
                font-size: 14px;
                flex: 1 1 auto;
                min-width: 0;
                justify-content: center;
            }
            .action-buttons-container {
                gap: 8px;
                padding: 0 4px;
            }
            .search-container {
                padding: 0 12px;
            }
            #searchForm {
                display: flex;
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            .search-input-group {
                width: 100%;
            }
            .search-input, .search-btn, .qr-scan-btn {
                min-height: 44px;
                font-size: 16px;
            }
            .search-options {
                flex-direction: row !important;
                justify-content: center !important;
                gap: 8px !important;
                margin-top: 0 !important;
            }
            .search-option {
                flex: 1;
                min-width: 0;
                padding: 10px 12px;
                margin: 0 !important;
                min-height: 44px;
                display: flex;
                align-items: center;
            }
            .search-option span {
                font-size: 13px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .search-option input[type="checkbox"] {
                transform: scale(1.1);
                min-width: 22px;
                min-height: 22px;
            }
            .school-selection-message {
                margin: 12px;
                padding: 20px 16px;
            }
            /* 모바일 카드: 수정·삭제·검사확인 버튼 너비·높이 통일 */
            .card-actions {
                display: flex !important;
                flex-direction: row !important;
                gap: 8px !important;
                align-items: stretch !important;
                flex-wrap: nowrap !important;
            }
            .card-actions .btn,
            .card-actions form,
            .card-actions .inspection-checkbox-mobile {
                flex: 1 1 0 !important;
                min-width: 0 !important;
                width: 0 !important;
                height: 38px !important;
                min-height: 38px !important;
                box-sizing: border-box !important;
            }
            .card-actions .btn,
            .card-actions form {
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }
            .card-actions .inspection-checkbox-mobile {
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                padding: 6px 8px !important;
            }
        }
        @media (max-width: 480px) {
            .action-buttons-container {
                display: grid !important;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            .action-buttons-container .btn,
            .action-buttons-container a.btn {
                width: 100%;
                min-width: 0;
                justify-content: center;
            }
        }
        
        /* 태블릿 반응형 스타일 */
        @media (max-width: 1024px) and (min-width: 769px) {
            .search-options {
                gap: 15px !important;
            }
            
            .search-option {
                padding: 10px 14px;
            }
        }
        
        /* 엑셀 다운로드 로딩 오버레이 */
        .excel-loading-overlay {
            display: none;
            position: fixed;
            z-index: 99999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        
        .excel-loading-content {
            background-color: white;
            padding: 30px 50px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .excel-loading-content i {
            font-size: 32px;
            color: #28a745;
            margin-bottom: 15px;
        }
        
        .excel-loading-content span {
            display: block;
            font-size: 18px;
            color: #333;
            font-weight: 500;
        }
    </style>
</head>
<body class="device-list-page">
    <!-- 네비게이션 바 포함 -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>
    
    <div class="container">
        <div class="device-list-container" style="position: relative;">
                        <!-- 검사모드 전용 버튼들 (컨테이너 우측 상단) -->
                        <div id="inspectionModeButtons" th:style="${inspectionMode ? 'display: block;' : 'display: none;'}" style="position: absolute; top: 20px; right: 20px; z-index: 100;">
                            <button class="btn btn-danger" onclick="resetInspection()" style="float: right;">
                                <i class="fas fa-undo"></i> 초기화
                            </button>
                        </div>
            
            <!-- 성공 메시지 표시 -->
            <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle"></i>
                <span th:text="${successMessage}"></span>
                <button type="button" class="btn-close" onclick="this.parentElement.style.display='none'"></button>
            </div>
            
            <div class="title">
                <div class="subject" id="pageTitle" th:text="${inspectionMode ? '장비검사' : '장비 목록'}">장비 목록</div>
                <div class="subtitle" id="pageSubtitle" th:text="${inspectionMode ? '장비 상태를 확인하고 검사하세요!' : '학교별, 유형별로 장비를 관리하세요!'}">학교별, 유형별로 장비를 관리하세요!</div>
            </div>
            
            <!-- 검색 기능 -->
            <div class="search-container">
                <form th:action="@{/device/list}" method="get" class="search-form" id="searchForm">
                    <input type="hidden" name="schoolId" th:value="${selectedSchoolId}" />
                    <input type="hidden" name="classroomId" th:value="${selectedClassroomId}" />
                    <input type="hidden" name="type" th:value="${selectedType}" />
                    <input type="hidden" name="page" value="1" />
                    <input type="hidden" name="size" th:value="${pageSize}" />
                    <input type="hidden" name="inspectionMode" id="inspectionModeParam" />
                    <input type="hidden" name="showClassroomsWithDevices" id="searchShowClassroomsWithDevices" />
                    
                    <div class="search-input-group">
                        <input type="text" name="searchKeyword" 
                               th:value="${searchKeyword}" 
                               placeholder="모델명, 제조사, IP주소, 고유번호로 검색" 
                               class="search-input" id="searchInput" />
                        <button type="submit" class="search-btn">
                            <i class="fas fa-search"></i>
                        </button>
                        <button type="button" class="qr-scan-btn" id="qrScanBtn" title="QR 코드 스캔">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                    
                    <!-- 검색 옵션 체크박스들 -->
                    <div class="search-options" style="margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                        <label class="search-option">
                            <input type="checkbox" id="showClassroomsWithDevices" th:checked="${showClassroomsWithDevices}" />
                            <span>장비가 있는 교실</span>
                        </label>
                        <label class="search-option">
                            <input type="checkbox" id="qrCodeSearch" />
                            <span>QR코드검색</span>
                        </label>
                    </div>
                </form>
                <script>
                    // QR코드 검색 체크박스 상태 즉시 복원 (페이지 로드 전)
                    (function() {
                        const savedQrCodeSearch = localStorage.getItem('qrCodeSearch');
                        if (savedQrCodeSearch === 'true') {
                            const qrCheckbox = document.getElementById('qrCodeSearch');
                            if (qrCheckbox) {
                                qrCheckbox.checked = true;
                            }
                        }
                    })();
                </script>
            </div>
            <div class="main">
                <div class="filter-container">
                    <form th:action="@{/device/list}" method="get" class="d-flex align-items-center" id="filterForm" onsubmit="return false;">
                        <input type="hidden" name="inspectionMode" id="filterInspectionModeParam" />
                        <input type="hidden" name="schoolId" id="filterSchoolIdParam" th:value="${selectedSchoolId}" />
                        <input type="hidden" name="searchKeyword" th:value="${searchKeyword}" />
                        <input type="hidden" name="page" value="1" />
                        <input type="hidden" name="size" th:value="${pageSize}" />
                        <input type="hidden" name="showClassroomsWithDevices" id="filterShowClassroomsWithDevices" />
                        <div class="filter-form-grid">
                        <select name="schoolId" id="schoolSelect" th:disabled="${inspectionMode}" class="filter-select">
                            <option value="">전체 학교</option>
                            <option th:each="school : ${schools}" 
                                    th:value="${school.schoolId}"
                                    th:text="${school.schoolName}"
                                    th:selected="${selectedSchoolId} == ${school.schoolId}">
                            </option>
                        </select>
                        <select name="classroomId" id="classroomSelect" class="filter-select">
                            <option value="">전체 교실</option>
                            <option th:each="classroom : ${classrooms}" 
                                    th:value="${classroom.classroomId}"
                                    th:text="${classroom.roomName}"
                                    th:selected="${selectedClassroomId} == ${classroom.classroomId}">
                            </option>
                        </select>
                        <select name="type" id="typeSelect" class="filter-select">
                            <option value="">전체 유형</option>
                            <option th:each="t : ${types}"
                                    th:value="${t}"
                                    th:text="${t}"
                                    th:selected="${selectedType} == ${t}">
                            </option>
                        </select>
                        <div class="filter-checkbox-group">
                            <label class="filter-checkbox-item">
                                <input type="checkbox" id="sortByPurposeCheckbox"
                                       th:checked="${sortByPurpose == true}" />
                                <span>용도</span>
                            </label>
                            <input type="hidden" name="sortByPurpose" id="sortByPurposeHidden" th:value="${sortByPurpose == true ? 'true' : ''}" />
                            <label class="filter-checkbox-item unused-item">
                                <input type="checkbox" id="showUnusedOnlyCheckbox"
                                       th:checked="${selectedShowUnusedOnly == true}" />
                                <span>불용</span>
                            </label>
                            <input type="hidden" name="showUnusedOnly" id="showUnusedOnlyHidden" th:value="${selectedShowUnusedOnly == true ? 'true' : ''}" />
                        </div>
                        </div>
                        <input type="hidden" name="page" value="1" />
                        <input type="hidden" name="size" th:value="${pageSize}" />
                    </form>
                    <div class="action-buttons-container">
                        <a th:href="|@{/device/register}?returnUrl=${listUrlEncoded}|" class="btn btn-primary">
                            <i class="fas fa-plus-circle" style="color: white;"></i> <span style="color: white;">장비 등록</span>
                        </a>
                        <button id="inspectionModeBtn" class="btn btn-warning" onclick="openInspectionMode()" th:style="${inspectionMode ? 'display: none;' : ''}">
                            <i class="fas fa-clipboard-check" style="color: white;"></i> <span style="color: white;">장비검사</span>
                        </button>
                        <button id="deviceListBtn" class="btn btn-orange" onclick="openDeviceList()" th:style="${inspectionMode ? '' : 'display: none;'}">
                            <i class="fas fa-list" style="color: white;"></i> <span style="color: white;">장비목록</span>
                        </button>
                        <button id="qrDownloadBtn" class="btn btn-info" onclick="openQrDownloadModal()" th:style="${inspectionMode ? 'display: none !important;' : ''}">
                            <i class="fas fa-qrcode" style="color: white;"></i> <span style="color: white;">QR 다운</span>
                        </button>
                        <button id="inspectionStatusBtn" class="btn btn-info" onclick="openInspectionStatusModal()" th:style="${inspectionMode ? '' : 'display: none !important;'}">
                            <i class="fas fa-chart-pie" style="color: white;"></i> <span style="color: white;">검사현황</span>
                        </button>
                        <a th:href="@{/device/excel(schoolId=${selectedSchoolId}, type=${selectedType}, classroomId=${selectedClassroomId}, sortByPurpose=${sortByPurpose})}" class="btn btn-success" id="excelDownloadBtn" onclick="downloadExcelWithInspection(event)">
                            <i class="fas fa-file-excel" style="color: white;"></i> <span style="color: white;">엑셀 다운로드</span>
                        </a>
                        <a th:href="@{/device/history/list(schoolId=${selectedSchoolId})}" class="btn btn-info">
                            <i class="fas fa-history"></i> <span>수정내역</span>
                        </a>
                    </div>
                    <script>
                        // 장비검사/장비목록 버튼용 - 버튼 바로 아래에서 전역에 정의하여 onclick에서 항상 호출 가능
                        window.openInspectionMode = function() {
                            if (typeof selectedSchoolForInspection !== 'undefined') selectedSchoolForInspection = null;
                            var dropdown = document.getElementById('schoolSelectDropdown');
                            if (dropdown) {
                                dropdown.innerHTML = '<option value="">학교를 선택하세요...</option>';
                                dropdown.disabled = false;
                            }
                            var customWrap = document.getElementById('schoolSelectCustom');
                            if (customWrap) customWrap.classList.remove('open');
                            var trigger = document.getElementById('schoolSelectTrigger');
                            if (trigger) trigger.setAttribute('aria-expanded', 'false');
                            if (typeof loadSchoolsForInspection === 'function') loadSchoolsForInspection();
                            var modal = document.getElementById('schoolSelectModal');
                            if (modal) modal.style.display = 'flex';
                        };
                        window.openDeviceList = function() { window.location.href = '/device/list'; };
                        window.loadSchoolsForInspection = function() {
                            fetch('/device/api/schools')
                                .then(function(r) { return r.json(); })
                                .then(function(schools) {
                                    var schoolSelect = document.getElementById('schoolSelectDropdown');
                                    var optionsContainer = document.getElementById('schoolSelectOptions');
                                    var triggerText = document.querySelector('.school-select-trigger-text');
                                    if (schoolSelect) {
                                        schoolSelect.innerHTML = '<option value="">학교를 선택하세요...</option>';
                                        (schools || []).forEach(function(school) {
                                            var option = document.createElement('option');
                                            option.value = String(school.schoolId);
                                            option.textContent = school.schoolName;
                                            schoolSelect.appendChild(option);
                                        });
                                        schoolSelect.disabled = false;
                                    }
                                    if (optionsContainer && triggerText) {
                                        optionsContainer.innerHTML = '';
                                        (schools || []).forEach(function(school) {
                                            var div = document.createElement('div');
                                            div.className = 'school-select-option';
                                            div.setAttribute('data-school-id', String(school.schoolId));
                                            div.textContent = school.schoolName;
                                            optionsContainer.appendChild(div);
                                        });
                                        triggerText.textContent = '학교를 선택하세요...';
                                    }
                                })
                                .catch(function(err) { console.error('Error:', err); });
                        };
                    </script>
                    
                </div>
                
                <!-- 학교 선택 안내 메시지 (학교 미선택 시 표시, API로 목록 로드 시 JS에서 숨김) -->
                <div id="school-selection-message" class="school-selection-message" th:style="${selectedSchoolId != null and selectedSchoolId != ''} ? 'display: none;' : ''">
                    <div class="message-container">
                        <i class="fas fa-school"></i>
                        <h3>학교를 선택해주세요</h3>
                        <p>장비 목록을 보려면 위에서 학교를 선택해주세요.</p>
                    </div>
                </div>
                
                <!-- 데스크톱 테이블 뷰 (항상 DOM에 두어 API 모드·자동화에서 학교 선택 시 목록 갱신 가능) -->
                <div id="device-table-scroll-wrapper" class="device-table-scroll-wrapper" th:style="${selectedSchoolId == null or selectedSchoolId == ''} ? 'display: none;' : ''">
                <table id="device-table" class="device-table" th:style="${selectedSchoolId == null or selectedSchoolId == ''} ? 'display: none;' : ''">
                    <thead>
                        <tr>
                            <th>학교</th>
                            <th>고유번호</th>
                            <th>CNo</th>
                            <th>관리번호</th>
                            <th>유형</th>
                            <th>직위</th>
                            <th>담당자</th>
                            <th>제조사</th>
                            <th>모델명</th>
                            <th>도입일자</th>
                            <th>IP주소</th>
                            <th>교실</th>
                            <th>용도</th>
                            <th>set분류</th>
                            <th>비고</th>
                            <th>불용</th>
                            <th>관리</th>
                            <th id="inspectionColumn" th:style="${inspectionMode ? '' : 'display: none;'}">검사확인</th>
                        </tr>
                    </thead>
                    <tbody id="device-tbody">
                        <th:block th:each="device, iterStat : ${devices}">
                            <!-- 용도 헤더 표시 (용도별 정렬이 체크되고 새로운 용도일 때) -->
                            <tr th:if="${sortByPurpose == true and 
                                       (iterStat.index == 0 or 
                                        (device.purpose != null ? device.purpose : '') != (devices[iterStat.index - 1].purpose != null ? devices[iterStat.index - 1].purpose : ''))}" 
                                class="purpose-header" style="background-color: #e8f4f8;">
                                <td colspan="18">
                                    <strong>
                                        <i class="fas fa-tag"></i> 
                                        용도: <span th:text="${device.purpose != null and !device.purpose.isEmpty() ? device.purpose : '용도 없음'}"></span>
                                    </strong>
                                </td>
                            </tr>
                            
                            <!-- 교실 헤더 표시 (새로운 교실일 때) -->
                            <tr th:if="${iterStat.index == 0 or device.classroom?.roomName != devices[iterStat.index - 1].classroom?.roomName}" 
                                class="classroom-header">
                                <td colspan="18">
                                    <strong>
                                        <i class="fas fa-door-open"></i> 
                                        <span th:text="${device.classroom != null and device.classroom.roomName != null ? device.classroom.roomName : '미지정 교실'}"></span>
                                    </strong>
                                </td>
                            </tr>
                            
                            <!-- 세트타입 그룹 헤더 표시 (새로운 세트타입일 때) -->
                            <tr th:if="${device.setType != null and !device.setType.isEmpty() and 
                                       (iterStat.index == 0 or 
                                        device.classroom?.roomName != devices[iterStat.index - 1].classroom?.roomName or
                                        device.setType != devices[iterStat.index - 1].setType)}" 
                                class="group-header">
                                <td colspan="18">
                                    <strong>
                                        <i class="fas fa-layer-group"></i> 
                                        세트: <span th:text="${device.setType}"></span>
                                    </strong>
                                </td>
                            </tr>
                            
                            <!-- 담당자 그룹 헤더 표시 (세트가 없고 새로운 담당자일 때) -->
                            <tr th:if="${(device.setType == null or device.setType.isEmpty()) and 
                                       device.operator != null and device.operator.name != null and
                                       (iterStat.index == 0 or 
                                        device.classroom?.roomName != devices[iterStat.index - 1].classroom?.roomName or
                                        device.operator?.name != devices[iterStat.index - 1].operator?.name)}" 
                                class="group-header">
                                <td colspan="18">
                                    <strong>
                                        <i class="fas fa-user"></i> 
                                        담당자: <span th:text="${device.operator.name}"></span>
                                        <span th:if="${device.operator.position != null}">
                                            (<span th:text="${device.operator.position}"></span>)
                                        </span>
                                    </strong>
                                </td>
                            </tr>
                            
                            <!-- 장비 데이터 행 -->
                            <tr th:class="${device.setType != null and !device.setType.isEmpty() ? 'set-group-item' : 'operator-group-item'}">
                                <td data-label="학교" th:text="${device.school != null ? device.school.schoolName : '미지정'}"></td>
                                <td data-label="고유번호" th:utext="${device.uid != null ? @deviceService.highlightSearchKeyword(device.uid.displayUid, searchKeyword) : ''}"></td>
                                <td data-label="CNo" th:text="${device.comsNo != null ? device.comsNo : ''}"></td>
                                <td data-label="관리번호" th:text="${device.manage != null ? device.manage.displayId : ''}"></td>
                                <td data-label="유형" class="device-type" th:text="${device.type != null ? device.type : ''}"></td>
                                <td data-label="직위" th:text="${device.operator != null && device.operator.position != null ? device.operator.position : ''}"></td>
                                <td data-label="담당자" th:text="${device.operator != null && device.operator.name != null ? device.operator.name : ''}"></td>
                                <td data-label="제조사" th:utext="${device.manufacturer != null ? @deviceService.highlightSearchKeyword(device.manufacturer, searchKeyword) : ''}"></td>
                                <td data-label="모델명" th:utext="${device.modelName != null ? @deviceService.highlightSearchKeyword(device.modelName, searchKeyword) : ''}"></td>
                                <td data-label="구매일자" th:text="${device.purchaseDate != null ? #temporals.format(device.purchaseDate, 'yyyy년 MM월') : ''}"></td>
                                <td data-label="IP주소" class="ip-address" th:utext="${device.ipAddress != null ? @deviceService.highlightSearchKeyword(device.ipAddress, searchKeyword) : ''}"></td>
                                <td data-label="교실" th:text="${device.classroom != null && device.classroom.roomName != null ? device.classroom.roomName : ''}"></td>
                                <td data-label="용도" th:text="${device.purpose != null ? device.purpose : ''}"></td>
                                <td data-label="세트분류" th:text="${device.setType != null ? device.setType : ''}"></td>
                                <td data-label="비고" th:text="${device.note != null ? device.note : ''}"></td>
                                <td data-label="불용" th:text="${device.unused != null && device.unused ? 'Y' : 'N'}"></td>
                                <td data-label="관리">
                                    <div class="action-buttons">
                                        <a th:href="@{/device/modify/{id}(id=${device.deviceId}, returnUrl=${listUrlEncoded})}" class="btn btn-warning">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <form th:action="@{/device/remove}" method="post" style="display: inline;">
                                            <input type="hidden" name="device_id" th:value="${device.deviceId}">
                                            <button type="submit" class="btn btn-danger" onclick="return confirm('정말 삭제하시겠습니까?')">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                                <td data-label="검사확인" id="inspectionCell" th:style="${inspectionMode ? '' : 'display: none;'}">
                                    <div class="inspection-checkbox" th:data-device-id="${device.deviceId}" onclick="toggleInspection(this)">
                                        <i th:if="${inspectionStatuses != null and inspectionStatuses.containsKey(device.deviceId) and inspectionStatuses.get(device.deviceId) == 'confirmed'}" 
                                           class="fas fa-check-circle inspection-icon confirmed" 
                                           style="color: #28a745;"></i>
                                        <i th:if="${inspectionStatuses != null and inspectionStatuses.containsKey(device.deviceId) and inspectionStatuses.get(device.deviceId) == 'modified'}" 
                                           class="fas fa-check-circle inspection-icon modified" 
                                           style="color: #ffc107;"></i>
                                        <i th:if="${inspectionStatuses == null or !inspectionStatuses.containsKey(device.deviceId) or inspectionStatuses.get(device.deviceId) == 'unchecked'}" 
                                           class="fas fa-check-circle inspection-icon unchecked" 
                                           style="color: #ccc;"></i>
                                    </div>
                                </td>
                            </tr>
                        </th:block>
                    </tbody>
                </table>
                </div>
                
                <!-- 모바일 카드 뷰 (항상 DOM에 두어 API 모드에서 목록 갱신 가능) -->
                <div id="device-cards" class="mobile-card-container" th:style="${selectedSchoolId == null or selectedSchoolId == ''} ? 'display: none;' : ''">
                    <th:block th:each="device, iterStat : ${devices}">
                        <!-- 용도 헤더 표시 (용도별 정렬이 체크되고 새로운 용도일 때) -->
                        <div th:if="${sortByPurpose == true and 
                                   (iterStat.index == 0 or 
                                    (device.purpose != null ? device.purpose : '') != (devices[iterStat.index - 1].purpose != null ? devices[iterStat.index - 1].purpose : ''))}" 
                             class="purpose-header-mobile" style="background-color: #e8f4f8; padding: 10px; margin: 10px 0; border-radius: 5px;">
                            <h3>
                                <i class="fas fa-tag"></i> 
                                용도: <span th:text="${device.purpose != null and !device.purpose.isEmpty() ? device.purpose : '용도 없음'}"></span>
                            </h3>
                        </div>
                        
                        <!-- 교실 헤더 표시 (새로운 교실일 때) -->
                        <div th:if="${iterStat.index == 0 or device.classroom?.roomName != devices[iterStat.index - 1].classroom?.roomName}" 
                             class="classroom-header-mobile">
                            <h3>
                                <i class="fas fa-door-open"></i> 
                                <span th:text="${device.classroom != null and device.classroom.roomName != null ? device.classroom.roomName : '미지정 교실'}"></span>
                            </h3>
                        </div>
                        
                        <!-- 세트타입 그룹 헤더 표시 (새로운 세트타입일 때) -->
                        <div th:if="${device.setType != null and !device.setType.isEmpty() and 
                                   (iterStat.index == 0 or 
                                    device.classroom?.roomName != devices[iterStat.index - 1].classroom?.roomName or
                                    device.setType != devices[iterStat.index - 1].setType)}" 
                             class="group-header-mobile">
                            <h4>
                                <i class="fas fa-layer-group"></i> 
                                세트: <span th:text="${device.setType}"></span>
                            </h4>
                        </div>
                        
                        <!-- 담당자 그룹 헤더 표시 (세트가 없고 새로운 담당자일 때) -->
                        <div th:if="${(device.setType == null or device.setType.isEmpty()) and 
                                   device.operator != null and device.operator.name != null and
                                   (iterStat.index == 0 or 
                                    device.classroom?.roomName != devices[iterStat.index - 1].classroom?.roomName or
                                    device.operator?.name != devices[iterStat.index - 1].operator?.name)}" 
                             class="group-header-mobile">
                            <h4>
                                <i class="fas fa-user"></i> 
                                담당자: <span th:text="${device.operator.name}"></span>
                                <span th:if="${device.operator.position != null}">
                                    (<span th:text="${device.operator.position}"></span>)
                                </span>
                            </h4>
                        </div>
                        
                        <!-- 장비 카드 -->
                        <div class="device-card">
                            <div class="card-header">
                                <div class="card-title" th:text="${device.type != null ? device.type : '장비'}">유형</div>
                                <div class="card-school" th:text="${device.school != null ? device.school.schoolName : '미지정'}">학교</div>
                            </div>
                            
                            <div class="card-content">
                                <div class="card-field">
                                    <div class="field-label">고유번호</div>
                                    <div class="field-value" th:if="${device.uid != null && device.uid.displayUid != null && !#strings.isEmpty(device.uid.displayUid)}" th:utext="${@deviceService.highlightSearchKeyword(device.uid.displayUid, searchKeyword)}"></div>
                                    <div class="field-value" th:if="${device.uid == null || device.uid.displayUid == null || #strings.isEmpty(device.uid.displayUid)}" style="color: #9ca3af;">-</div>
                                </div>
                                
                                <div class="card-field">
                                    <div class="field-label">CNo</div>
                                    <div class="field-value" th:if="${device.comsNo != null && !#strings.isEmpty(device.comsNo)}" th:text="${device.comsNo}"></div>
                                    <div class="field-value" th:if="${device.comsNo == null || #strings.isEmpty(device.comsNo)}" style="color: #9ca3af;">-</div>
                                </div>
                                <div class="card-field">
                                    <div class="field-label">관리번호</div>
                                    <div class="field-value" th:if="${device.manage != null && device.manage.displayId != null && !#strings.isEmpty(device.manage.displayId)}" th:text="${device.manage.displayId}"></div>
                                    <div class="field-value" th:if="${device.manage == null || device.manage.displayId == null || #strings.isEmpty(device.manage.displayId)}" style="color: #9ca3af;">-</div>
                                </div>
                                
                                <div class="card-field">
                                    <div class="field-label">직위</div>
                                    <div class="field-value" th:if="${device.operator != null && device.operator.position != null && !#strings.isEmpty(device.operator.position)}" th:text="${device.operator.position}"></div>
                                    <div class="field-value" th:if="${device.operator == null || device.operator.position == null || #strings.isEmpty(device.operator.position)}" style="color: #9ca3af;">-</div>
                                </div>
                                
                                <div class="card-field">
                                    <div class="field-label">담당자</div>
                                    <div class="field-value" th:if="${device.operator != null && device.operator.name != null && !#strings.isEmpty(device.operator.name)}" th:text="${device.operator.name}"></div>
                                    <div class="field-value" th:if="${device.operator == null || device.operator.name == null || #strings.isEmpty(device.operator.name)}" style="color: #9ca3af;">-</div>
                                </div>
                                
                                <div class="card-field">
                                    <div class="field-label">제조사</div>
                                    <div class="field-value" th:if="${device.manufacturer != null && !#strings.isEmpty(device.manufacturer)}" th:utext="${@deviceService.highlightSearchKeyword(device.manufacturer, searchKeyword)}"></div>
                                    <div class="field-value" th:if="${device.manufacturer == null || #strings.isEmpty(device.manufacturer)}" style="color: #9ca3af;">-</div>
                                </div>
                                
                                <div class="card-field">
                                    <div class="field-label">모델명</div>
                                    <div class="field-value" th:if="${device.modelName != null && !#strings.isEmpty(device.modelName)}" th:utext="${@deviceService.highlightSearchKeyword(device.modelName, searchKeyword)}"></div>
                                    <div class="field-value" th:if="${device.modelName == null || #strings.isEmpty(device.modelName)}" style="color: #9ca3af;">-</div>
                                </div>
                                
                                <div class="card-field">
                                    <div class="field-label">구매일자</div>
                                    <div class="field-value" th:if="${device.purchaseDate != null}" th:text="${#temporals.format(device.purchaseDate, 'yyyy년 MM월')}"></div>
                                    <div class="field-value" th:if="${device.purchaseDate == null}" style="color: #9ca3af;">-</div>
                                </div>
                                
                                <div class="card-field">
                                    <div class="field-label">IP주소</div>
                                    <div class="field-value" th:if="${device.ipAddress != null && !#strings.isEmpty(device.ipAddress)}" th:utext="${@deviceService.highlightSearchKeyword(device.ipAddress, searchKeyword)}"></div>
                                    <div class="field-value" th:if="${device.ipAddress == null || #strings.isEmpty(device.ipAddress)}" style="color: #9ca3af;">-</div>
                                </div>
                                
                                <div class="card-field">
                                    <div class="field-label">교실</div>
                                    <div class="field-value" th:if="${device.classroom != null && device.classroom.roomName != null && !#strings.isEmpty(device.classroom.roomName)}" th:text="${device.classroom.roomName}"></div>
                                    <div class="field-value" th:if="${device.classroom == null || device.classroom.roomName == null || #strings.isEmpty(device.classroom.roomName)}" style="color: #9ca3af;">-</div>
                                </div>
                                
                                <div class="card-field">
                                    <div class="field-label">용도</div>
                                    <div class="field-value" th:if="${device.purpose != null && !#strings.isEmpty(device.purpose)}" th:text="${device.purpose}"></div>
                                    <div class="field-value" th:if="${device.purpose == null || #strings.isEmpty(device.purpose)}" style="color: #9ca3af;">-</div>
                                </div>
                                
                                <div class="card-field">
                                    <div class="field-label">세트분류</div>
                                    <div class="field-value" th:if="${device.setType != null && !#strings.isEmpty(device.setType)}" th:text="${device.setType}"></div>
                                    <div class="field-value" th:if="${device.setType == null || #strings.isEmpty(device.setType)}" style="color: #9ca3af;">-</div>
                                </div>
                                
                                <div class="card-field">
                                    <div class="field-label">불용</div>
                                    <div class="field-value" th:if="${device.unused != null && device.unused}" style="color: #dc2626; font-weight: 600;">Y</div>
                                    <div class="field-value" th:if="${device.unused == null || !device.unused}" style="color: #16a34a; font-weight: 600;">N</div>
                                </div>
                                
                                <div class="card-field full-width">
                                    <div class="field-label">비고</div>
                                    <div class="field-value" th:if="${device.note != null && !#strings.isEmpty(device.note)}" th:text="${device.note}"></div>
                                    <div class="field-value" th:if="${device.note == null || #strings.isEmpty(device.note)}" style="color: #9ca3af;">-</div>
                                </div>
                            </div>
                            
                            <div class="card-actions">
                                <a th:href="@{/device/modify/{id}(id=${device.deviceId}, returnUrl=${listUrlEncoded})}" class="btn btn-warning">
                                    <i class="fas fa-edit"></i> 수정
                                </a>
                                <form th:action="@{/device/remove}" method="post" style="display: inline;">
                                    <input type="hidden" name="device_id" th:value="${device.deviceId}">
                                    <button type="submit" class="btn btn-danger" onclick="return confirm('정말 삭제하시겠습니까?')">
                                        <i class="fas fa-trash-alt"></i> 삭제
                                    </button>
                                </form>
                                <!-- 검사확인 체크박스 (검사모드일 때만 표시) -->
                                <div th:if="${inspectionMode}" 
                                     th:classappend="${inspectionStatuses != null and inspectionStatuses.containsKey(device.deviceId) ? 
                                                      (inspectionStatuses.get(device.deviceId) == 'confirmed' ? 'state-confirmed' : 
                                                       (inspectionStatuses.get(device.deviceId) == 'modified' ? 'state-modified' : 'state-unchecked')) : 'state-unchecked'}" 
                                     class="inspection-checkbox-mobile" 
                                     th:data-device-id="${device.deviceId}" 
                                     onclick="toggleInspection(this)">
                                    <i th:if="${inspectionStatuses != null and inspectionStatuses.containsKey(device.deviceId) and inspectionStatuses.get(device.deviceId) == 'confirmed'}" 
                                       class="fas fa-check-circle inspection-icon confirmed" 
                                       style="color: #28a745;"></i>
                                    <i th:if="${inspectionStatuses != null and inspectionStatuses.containsKey(device.deviceId) and inspectionStatuses.get(device.deviceId) == 'modified'}" 
                                       class="fas fa-check-circle inspection-icon modified" 
                                       style="color: #ffc107;"></i>
                                    <i th:if="${inspectionStatuses == null or !inspectionStatuses.containsKey(device.deviceId) or inspectionStatuses.get(device.deviceId) == 'unchecked'}" 
                                       class="fas fa-check-circle inspection-icon unchecked" 
                                       style="color: #ccc;"></i>
                                    <span class="inspection-label">검사확인</span>
                                </div>
                            </div>
                        </div>
                    </th:block>
                </div>
                
                <!-- 페이징 네비게이션 -->
                <nav id="device-pagination" th:if="${totalPages > 1}">
                    <ul class="pagination">
                        <li th:classappend="${startPage == 1} ? 'disabled'">
                            <a th:if="${startPage != 1}" 
                               th:href="@{/device/list(
                                   page=${startPage - 1},
                                   schoolId=${selectedSchoolId != null ? selectedSchoolId : null},
                                   type=${selectedType != null and selectedType != '' ? selectedType : null},
                                   classroomId=${selectedClassroomId != null ? selectedClassroomId : null}
                               )}"
                               th:text="'이전'"></a>
                            <a th:if="${startPage == 1}" href="javascript:void(0);" th:text="'이전'"></a>
                        </li>
                        <li th:each="pageNum : ${#numbers.sequence(startPage, endPage)}">
                            <a th:href="@{/device/list(
                                   page=${pageNum},
                                   schoolId=${selectedSchoolId != null ? selectedSchoolId : null},
                                   type=${selectedType != null and selectedType != '' ? selectedType : null},
                                   classroomId=${selectedClassroomId != null ? selectedClassroomId : null}
                               )}"
                               th:text="${pageNum}"
                               th:classappend="${pageNum == currentPage} ? 'active'"></a>
                        </li>
                        <li th:classappend="${endPage == totalPages} ? 'disabled'">
                            <a th:if="${endPage != totalPages}" 
                               th:href="@{/device/list(
                                   page=${endPage + 1},
                                   schoolId=${selectedSchoolId != null ? selectedSchoolId : null},
                                   type=${selectedType != null and selectedType != '' ? selectedType : null},
                                   classroomId=${selectedClassroomId != null ? selectedClassroomId : null}
                               )}"
                               th:text="'다음'"></a>
                            <a th:if="${endPage == totalPages}" href="javascript:void(0);" th:text="'다음'"></a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
    
    <!-- 푸터 포함 -->
    <div th:replace="~{fragments/footer :: footer}"></div>
    
    <!-- 학교 선택 모달 -->
    <div id="schoolSelectModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>장비검사 - 학교 선택</h2>
            </div>
            <div class="modal-body">
                <div class="school-select">
                    <label for="schoolSelectDropdown">학교 선택:</label>
                    <select id="schoolSelectDropdown" class="form-select school-select-native">
                        <option value="">학교를 선택하세요...</option>
                    </select>
                    <div class="school-select-custom" id="schoolSelectCustom" aria-hidden="true">
                        <button type="button" class="school-select-trigger" id="schoolSelectTrigger" aria-expanded="false">
                            <span class="school-select-trigger-text">학교를 선택하세요...</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="school-select-options" id="schoolSelectOptions"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="confirmSchoolSelect" class="confirm-btn">검사</button>
                <button id="cancelSchoolSelect" class="cancel-btn">취소</button>
            </div>
        </div>
    </div>
    
    <script>
        function updateClassrooms(schoolId) {
            const classroomSelect = document.getElementById('classroomSelect');
            const selectedClassroomId = classroomSelect.value; // 현재 선택된 교실 ID 저장
            classroomSelect.innerHTML = '<option value="">전체 교실</option>';
            
            if (schoolId) {
                fetch(`/device/api/classrooms/${schoolId}`)
                    .then(response => response.json())
                    .then(classrooms => {
                        classrooms.forEach(classroom => {
                            const option = document.createElement('option');
                            option.value = classroom.classroomId;
                            option.textContent = classroom.roomName;
                            if (classroom.classroomId == selectedClassroomId) {
                                option.selected = true;
                            }
                            classroomSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error:', error));
            } else {
                // 전체 학교일 때는 모든 교실 표시
                fetch('/device/api/classrooms')
                    .then(response => response.json())
                    .then(classrooms => {
                        classrooms.forEach(classroom => {
                            const option = document.createElement('option');
                            option.value = classroom.classroomId;
                            option.textContent = classroom.roomName;
                            if (classroom.classroomId == selectedClassroomId) {
                                option.selected = true;
                            }
                            classroomSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error:', error));
            }
        }
        
        // 교실 목록 업데이트 후 폼 제출
        function updateClassroomsAndSubmit(schoolId) {
            const classroomSelect = document.getElementById('classroomSelect');
            const selectedClassroomId = classroomSelect.value; // 현재 선택된 교실 ID 저장
            classroomSelect.innerHTML = '<option value="">전체 교실</option>';
            
            if (schoolId) {
                fetch(`/device/api/classrooms/${schoolId}`)
                    .then(response => response.json())
                    .then(classrooms => {
                        classrooms.forEach(classroom => {
                            const option = document.createElement('option');
                            option.value = classroom.classroomId;
                            option.textContent = classroom.roomName;
                            if (classroom.classroomId == selectedClassroomId) {
                                option.selected = true;
                            }
                            classroomSelect.appendChild(option);
                        });
                        // 교실 목록 업데이트 후 API로 목록 갱신
                        document.getElementById('filterSchoolIdParam').value = schoolId;
                        loadDeviceListApi(1);
                    })
                    .catch(error => console.error('Error:', error));
            } else {
                // 전체 학교일 때는 모든 교실 표시
                fetch('/device/api/classrooms')
                    .then(response => response.json())
                    .then(classrooms => {
                        classrooms.forEach(classroom => {
                            const option = document.createElement('option');
                            option.value = classroom.classroomId;
                            option.textContent = classroom.roomName;
                            if (classroom.classroomId == selectedClassroomId) {
                                option.selected = true;
                            }
                            classroomSelect.appendChild(option);
                        });
                        document.getElementById('filterSchoolIdParam').value = '';
                        loadDeviceListApi(1);
                    })
                    .catch(error => console.error('Error:', error));
            }
        }
        
        // 용도별 정렬 체크박스 변경 처리
        function handlePurposeSortChange() {
            const checkbox = document.getElementById('sortByPurposeCheckbox');
            const hiddenInput = document.getElementById('sortByPurposeHidden');
            if (checkbox && hiddenInput) {
                hiddenInput.value = checkbox.checked ? 'true' : '';
            }
            updateSchoolIdAndSubmit();
        }
        
        function handleUnusedOnlyChange() {
            const checkbox = document.getElementById('showUnusedOnlyCheckbox');
            const hiddenInput = document.getElementById('showUnusedOnlyHidden');
            if (checkbox && hiddenInput) {
                hiddenInput.value = checkbox.checked ? 'true' : '';
            }
            updateSchoolIdAndSubmit();
        }
        
        // 학교 ID 업데이트 후 API로 목록 갱신 (페이지 전체 새로고침 없음)
        function updateSchoolIdAndSubmit() {
            const schoolSelect = document.getElementById('schoolSelect');
            const filterSchoolIdParam = document.getElementById('filterSchoolIdParam');
            
            if (schoolSelect && filterSchoolIdParam) {
                filterSchoolIdParam.value = schoolSelect.value;
            }
            
            loadDeviceListApi(1);
        }
        
        // 장비 목록 API 호출 후 테이블/카드/페이징 렌더링
        function loadDeviceListApi(page) {
            const form = document.getElementById('filterForm');
            if (!form) return;
            // 학교 미선택 등으로 테이블이 없으면 전체 페이지 로드로 이동 (검색어·장비가 있는 교실은 필터 폼에 반영)
            if (!document.getElementById('device-tbody')) {
                var searchInputEl = document.getElementById('searchInput');
                var showCb = document.getElementById('showClassroomsWithDevices');
                var kwHidden = form.querySelector('[name="searchKeyword"]');
                var showHidden = document.getElementById('filterShowClassroomsWithDevices');
                if (searchInputEl && kwHidden) kwHidden.value = searchInputEl.value || '';
                if (showCb && showHidden) showHidden.value = showCb.checked ? 'true' : '';
                form.submit();
                return;
            }
            const schoolSelectEl = document.getElementById('schoolSelect');
            const schoolId = (schoolSelectEl && schoolSelectEl.value) ? schoolSelectEl.value.trim() : '';
            // 학교 미선택 시 API 호출하지 않음 (403 방지). 안내 메시지 표시 후 리턴
            if (!schoolId) {
                var msgEl = document.getElementById('school-selection-message');
                var tableEl = document.getElementById('device-table');
                var tableWrapper = document.getElementById('device-table-scroll-wrapper');
                var cardsEl = document.getElementById('device-cards');
                if (msgEl) msgEl.style.display = '';
                if (tableEl) tableEl.style.display = 'none';
                if (tableWrapper) tableWrapper.style.display = 'none';
                if (cardsEl) cardsEl.style.display = 'none';
                var tbody = document.getElementById('device-tbody');
                if (tbody) tbody.innerHTML = '';
                var nav = document.getElementById('device-pagination');
                if (nav) nav.innerHTML = '';
                return;
            }
            const q = new URLSearchParams();
            q.set('schoolId', schoolId);
            const classroomSelectEl = document.getElementById('classroomSelect');
            const classroomId = (classroomSelectEl && classroomSelectEl.value) ? classroomSelectEl.value.trim() : '';
            if (classroomId) q.set('classroomId', classroomId);
            const typeSelectEl = form.querySelector('select[name="type"]');
            const type = (typeSelectEl && typeSelectEl.value) ? typeSelectEl.value.trim() : '';
            if (type) q.set('type', type);
            const sortByPurposeHidden = document.getElementById('sortByPurposeHidden');
            if (sortByPurposeHidden && sortByPurposeHidden.value === 'true') q.set('sortByPurpose', 'true');
            const showUnusedOnlyHidden = document.getElementById('showUnusedOnlyHidden');
            if (showUnusedOnlyHidden && showUnusedOnlyHidden.value === 'true') q.set('showUnusedOnly', 'true');
            const searchInputForKeyword = document.getElementById('searchInput');
            const searchKeyword = (searchInputForKeyword && searchInputForKeyword.value) ? searchInputForKeyword.value.trim() : '';
            if (searchKeyword) q.set('searchKeyword', searchKeyword);
            const showClassroomsCheckbox = document.getElementById('showClassroomsWithDevices');
            if (showClassroomsCheckbox && showClassroomsCheckbox.checked) q.set('showClassroomsWithDevices', 'true');
            const inspectionModeEl = document.getElementById('filterInspectionModeParam');
            if (inspectionModeEl && inspectionModeEl.value === 'true') q.set('inspectionMode', 'true');
            const sizeEl = form.querySelector('input[name="size"]');
            const size = (sizeEl && sizeEl.value) ? sizeEl.value : '16';
            q.set('page', String(page));
            q.set('size', size);
            
            const apiUrl = '/device/api/list?' + q.toString();
            if (typeof console !== 'undefined' && console.log) {
                console.log('[장비목록 필터] API 호출:', apiUrl, '| 파라미터:', { schoolId: schoolId || '(전체)', classroomId: classroomId || '(전체)', type: type || '(전체)', page: page, sortByPurpose: !!sortByPurposeHidden && sortByPurposeHidden.value === 'true', showUnusedOnly: !!showUnusedOnlyHidden && showUnusedOnlyHidden.value === 'true', searchKeyword: searchKeyword || '(없음)', showClassroomsWithDevices: !!showClassroomsCheckbox && showClassroomsCheckbox.checked });
            }
            fetch(apiUrl)
                .then(function(r) {
                    if (!r.ok) { throw new Error('목록 조회 실패: ' + r.status); }
                    return r.json();
                })
                .then(function(data) {
                    if (typeof console !== 'undefined' && console.log) {
                        console.log('[장비목록 필터] API 응답: 장비', (data.devices && data.devices.length) || 0, '건, 현재페이지', data.currentPage, '/', data.totalPages);
                    }
                    if (!data || !Array.isArray(data.devices)) { return; }
                    renderDeviceTableBody(data);
                    renderDeviceCards(data);
                    renderDevicePagination(data);
                    var msgEl = document.getElementById('school-selection-message');
                    var tableEl = document.getElementById('device-table');
                    var tableWrapper = document.getElementById('device-table-scroll-wrapper');
                    if (msgEl) msgEl.style.display = 'none';
                    if (tableEl) tableEl.style.display = '';
                    if (tableWrapper) tableWrapper.style.display = '';
                    var cardsEl = document.getElementById('device-cards');
                    if (cardsEl) cardsEl.style.display = '';
                    if (typeof applyInspectionStatuses === 'function' && data.inspectionStatuses && Object.keys(data.inspectionStatuses).length) {
                        setTimeout(function() { applyInspectionStatuses(data.inspectionStatuses); }, 100);
                    }
                    // 검색어가 있으면 첫 번째 강조(빨간글씨)를 화면 중앙으로 즉시 스크롤 (PC/태블릿/모바일 동일)
                    var keyword = (data.searchKeyword && data.searchKeyword.trim()) ? data.searchKeyword.trim() : '';
                    if (keyword) {
                        var isMobile = window.innerWidth <= 768;
                        var scrollDelay = 100;
                        setTimeout(function() {
                            var cardsContainer = document.getElementById('device-cards');
                            var first = isMobile && cardsContainer
                                ? cardsContainer.querySelector('.search-highlight')
                                : document.querySelector('.search-highlight');
                            if (!first) return;
                            var scrollTarget = (isMobile && first.closest('.device-card')) ? first.closest('.device-card') : first;
                            requestAnimationFrame(function() {
                                var rect = scrollTarget.getBoundingClientRect();
                                if (rect.height === 0) return;
                                var scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                                var targetY = scrollTop + rect.top - (window.innerHeight / 2) + (rect.height / 2);
                                targetY = Math.max(0, targetY);
                                window.scrollTo({ top: targetY, behavior: 'auto' });
                            });
                        }, scrollDelay);
                    }
                    // QR코드검색 모드: 검색 후 검색창 비워서 다음 스캔 준비
                    var qrCb = document.getElementById('qrCodeSearch');
                    var searchInputToClear = document.getElementById('searchInput');
                    if (qrCb && qrCb.checked && searchInputToClear) {
                        searchInputToClear.value = '';
                    }
                })
                .catch(function(err) {
                    console.error('장비 목록 API 오류:', err);
                    if (typeof alert !== 'undefined') alert('장비 목록을 불러오지 못했습니다. 새로고침 후 다시 시도해 주세요.');
                });
        }
        
        function escapeHtml(s) {
            if (s == null || s === '') return '';
            var div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }
        function highlightKeyword(text, keyword) {
            if (!keyword || !text) return escapeHtml(text);
            var escaped = escapeHtml(text);
            var kw = escapeHtml(keyword);
            var re = new RegExp('(' + kw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
            return escaped.replace(re, '<span class="search-highlight">$1</span>');
        }
        
        function renderDeviceTableBody(data) {
            var tbody = document.getElementById('device-tbody');
            if (!tbody) return;
            var devices = data.devices || [];
            var sortByPurpose = data.sortByPurpose;
            var listUrlEncoded = data.listUrlEncoded || '';
            var inspectionMode = data.inspectionMode;
            var statuses = data.inspectionStatuses || {};
            var keyword = data.searchKeyword || '';
            var html = '';
            for (var i = 0; i < devices.length; i++) {
                var d = devices[i];
                var prev = i > 0 ? devices[i - 1] : null;
                var prevPurpose = prev ? (prev.purpose || '') : '';
                var prevRoom = prev ? (prev.classroomName || '') : '';
                var prevSet = prev ? (prev.setType || '') : '';
                var prevOp = prev ? (prev.operatorName || '') : '';
                if (sortByPurpose && (i === 0 || (d.purpose || '') !== prevPurpose)) {
                    html += '<tr class="purpose-header" style="background-color: #e8f4f8;"><td colspan="18"><strong><i class="fas fa-tag"></i> 용도: ' + escapeHtml(d.purpose && d.purpose.length ? d.purpose : '용도 없음') + '</strong></td></tr>';
                }
                if (i === 0 || (d.classroomName || '') !== prevRoom) {
                    html += '<tr class="classroom-header"><td colspan="18"><strong><i class="fas fa-door-open"></i> ' + escapeHtml(d.classroomName || '미지정 교실') + '</strong></td></tr>';
                }
                if (d.setType && (i === 0 || d.classroomName !== prevRoom || d.setType !== prevSet)) {
                    html += '<tr class="group-header"><td colspan="18"><strong><i class="fas fa-layer-group"></i> 세트: ' + escapeHtml(d.setType) + '</strong></td></tr>';
                }
                if (!d.setType && d.operatorName && (i === 0 || d.classroomName !== prevRoom || d.operatorName !== prevOp)) {
                    html += '<tr class="group-header"><td colspan="18"><strong><i class="fas fa-user"></i> 담당자: ' + escapeHtml(d.operatorName) + (d.operatorPosition ? ' (' + escapeHtml(d.operatorPosition) + ')' : '') + '</strong></td></tr>';
                }
                var rowClass = d.setType ? 'set-group-item' : 'operator-group-item';
                var inspStatus = statuses[d.deviceId] || 'unchecked';
                var inspIcon = inspStatus === 'confirmed' ? ' style="color: #28a745;"' : (inspStatus === 'modified' ? ' style="color: #ffc107;"' : ' style="color: #ccc;"');
                var modifyUrl = '/device/modify/' + d.deviceId + (listUrlEncoded ? '?returnUrl=' + listUrlEncoded : '');
                html += '<tr class="' + rowClass + '">';
                html += '<td data-label="학교">' + escapeHtml(d.schoolName || '미지정') + '</td>';
                html += '<td data-label="고유번호">' + highlightKeyword(d.uidDisplay || '', keyword) + '</td>';
                html += '<td data-label="CNo">' + escapeHtml(d.cNo || '') + '</td>';
                html += '<td data-label="관리번호">' + escapeHtml(d.manageDisplay || '') + '</td>';
                html += '<td data-label="유형" class="device-type">' + escapeHtml(d.type || '') + '</td>';
                html += '<td data-label="직위">' + escapeHtml(d.operatorPosition || '') + '</td>';
                html += '<td data-label="담당자">' + escapeHtml(d.operatorName || '') + '</td>';
                html += '<td data-label="제조사">' + highlightKeyword(d.manufacturer || '', keyword) + '</td>';
                html += '<td data-label="모델명">' + highlightKeyword(d.modelName || '', keyword) + '</td>';
                html += '<td data-label="구매일자">' + escapeHtml(d.purchaseDateFormatted || '') + '</td>';
                html += '<td data-label="IP주소" class="ip-address">' + highlightKeyword(d.ipAddress || '', keyword) + '</td>';
                html += '<td data-label="교실">' + escapeHtml(d.classroomName || '') + '</td>';
                html += '<td data-label="용도">' + escapeHtml(d.purpose || '') + '</td>';
                html += '<td data-label="세트분류">' + escapeHtml(d.setType || '') + '</td>';
                html += '<td data-label="비고">' + escapeHtml(d.note || '') + '</td>';
                html += '<td data-label="불용">' + (d.unused ? 'Y' : 'N') + '</td>';
                html += '<td data-label="관리"><div class="action-buttons"><a href="' + modifyUrl + '" class="btn btn-warning"><i class="fas fa-edit"></i></a><form action="/device/remove" method="post" style="display: inline;"><input type="hidden" name="device_id" value="' + d.deviceId + '"><button type="submit" class="btn btn-danger" onclick="return confirm(\'정말 삭제하시겠습니까?\')"><i class="fas fa-trash-alt"></i></button></form></div></td>';
                html += '<td data-label="검사확인" id="inspectionCell" style="' + (inspectionMode ? '' : 'display: none;') + '"><div class="inspection-checkbox" data-device-id="' + d.deviceId + '" onclick="toggleInspection(this)"><i class="fas fa-check-circle inspection-icon ' + inspStatus + '"' + inspIcon + '></i></div></td>';
                html += '</tr>';
            }
            tbody.innerHTML = html;
        }
        
        function renderDeviceCards(data) {
            var container = document.getElementById('device-cards');
            if (!container) return;
            var devices = data.devices || [];
            var sortByPurpose = data.sortByPurpose;
            var listUrlEncoded = data.listUrlEncoded || '';
            var statuses = data.inspectionStatuses || {};
            var keyword = data.searchKeyword || '';
            var inspectionMode = data.inspectionMode;
            var html = '';
            for (var i = 0; i < devices.length; i++) {
                var d = devices[i];
                var prev = i > 0 ? devices[i - 1] : null;
                if (sortByPurpose && (i === 0 || (d.purpose || '') !== (prev ? prev.purpose : ''))) {
                    html += '<div class="purpose-header-mobile" style="background-color: #e8f4f8; padding: 10px; margin: 10px 0; border-radius: 5px;"><h3><i class="fas fa-tag"></i> 용도: ' + escapeHtml(d.purpose && d.purpose.length ? d.purpose : '용도 없음') + '</h3></div>';
                }
                if (i === 0 || (d.classroomName || '') !== (prev ? prev.classroomName : '')) {
                    html += '<div class="classroom-header-mobile"><h3><i class="fas fa-door-open"></i> ' + escapeHtml(d.classroomName || '미지정 교실') + '</h3></div>';
                }
                if (d.setType && (i === 0 || d.classroomName !== (prev ? prev.classroomName : '') || d.setType !== (prev ? prev.setType : ''))) {
                    html += '<div class="group-header-mobile"><h4><i class="fas fa-layer-group"></i> 세트: ' + escapeHtml(d.setType) + '</h4></div>';
                }
                if (!d.setType && d.operatorName && (i === 0 || d.classroomName !== (prev ? prev.classroomName : '') || d.operatorName !== (prev ? prev.operatorName : ''))) {
                    html += '<div class="group-header-mobile"><h4><i class="fas fa-user"></i> 담당자: ' + escapeHtml(d.operatorName) + (d.operatorPosition ? ' (' + escapeHtml(d.operatorPosition) + ')' : '') + '</h4></div>';
                }
                var modifyUrl = '/device/modify/' + d.deviceId + (listUrlEncoded ? '?returnUrl=' + listUrlEncoded : '');
                var inspStatus = statuses[d.deviceId] || 'unchecked';
                html += '<div class="device-card"><div class="card-header"><div class="card-title">' + escapeHtml(d.type || '장비') + '</div><div class="card-school">' + escapeHtml(d.schoolName || '미지정') + '</div></div>';
                html += '<div class="card-content">';
                html += '<div class="card-field"><div class="field-label">고유번호</div><div class="field-value">' + (d.uidDisplay ? highlightKeyword(d.uidDisplay, keyword) : '<span style="color: #9ca3af;">-</span>') + '</div></div>';
                html += '<div class="card-field"><div class="field-label">CNo</div><div class="field-value">' + (d.cNo ? escapeHtml(d.cNo) : '<span style="color: #9ca3af;">-</span>') + '</div></div>';
                html += '<div class="card-field"><div class="field-label">관리번호</div><div class="field-value">' + (d.manageDisplay ? escapeHtml(d.manageDisplay) : '<span style="color: #9ca3af;">-</span>') + '</div></div>';
                html += '<div class="card-field"><div class="field-label">직위</div><div class="field-value">' + (d.operatorPosition ? escapeHtml(d.operatorPosition) : '<span style="color: #9ca3af;">-</span>') + '</div></div>';
                html += '<div class="card-field"><div class="field-label">담당자</div><div class="field-value">' + (d.operatorName ? escapeHtml(d.operatorName) : '<span style="color: #9ca3af;">-</span>') + '</div></div>';
                html += '<div class="card-field"><div class="field-label">제조사</div><div class="field-value">' + (d.manufacturer ? highlightKeyword(d.manufacturer, keyword) : '<span style="color: #9ca3af;">-</span>') + '</div></div>';
                html += '<div class="card-field"><div class="field-label">모델명</div><div class="field-value">' + (d.modelName ? highlightKeyword(d.modelName, keyword) : '<span style="color: #9ca3af;">-</span>') + '</div></div>';
                html += '<div class="card-field"><div class="field-label">구매일자</div><div class="field-value">' + (d.purchaseDateFormatted ? escapeHtml(d.purchaseDateFormatted) : '<span style="color: #9ca3af;">-</span>') + '</div></div>';
                html += '<div class="card-field"><div class="field-label">IP주소</div><div class="field-value">' + (d.ipAddress ? highlightKeyword(d.ipAddress, keyword) : '<span style="color: #9ca3af;">-</span>') + '</div></div>';
                html += '<div class="card-field"><div class="field-label">교실</div><div class="field-value">' + (d.classroomName ? escapeHtml(d.classroomName) : '<span style="color: #9ca3af;">-</span>') + '</div></div>';
                html += '<div class="card-field"><div class="field-label">용도</div><div class="field-value">' + (d.purpose ? escapeHtml(d.purpose) : '<span style="color: #9ca3af;">-</span>') + '</div></div>';
                html += '<div class="card-field"><div class="field-label">세트분류</div><div class="field-value">' + (d.setType ? escapeHtml(d.setType) : '<span style="color: #9ca3af;">-</span>') + '</div></div>';
                html += '<div class="card-field"><div class="field-label">불용</div><div class="field-value">' + (d.unused ? '<span style="color: #dc2626; font-weight: 600;">Y</span>' : '<span style="color: #16a34a; font-weight: 600;">N</span>') + '</div></div>';
                html += '<div class="card-field full-width"><div class="field-label">비고</div><div class="field-value">' + (d.note ? escapeHtml(d.note) : '<span style="color: #9ca3af;">-</span>') + '</div></div></div>';
                html += '<div class="card-actions"><a href="' + modifyUrl + '" class="btn btn-warning"><i class="fas fa-edit"></i> 수정</a><form action="/device/remove" method="post" style="display: inline;"><input type="hidden" name="device_id" value="' + d.deviceId + '"><button type="submit" class="btn btn-danger" onclick="return confirm(\'정말 삭제하시겠습니까?\')"><i class="fas fa-trash-alt"></i> 삭제</button></form>';
                if (inspectionMode) {
                    html += '<div class="inspection-checkbox-mobile state-' + inspStatus + '" data-device-id="' + d.deviceId + '" onclick="toggleInspection(this)"><i class="fas fa-check-circle inspection-icon ' + inspStatus + '" style="' + (inspStatus === 'confirmed' ? 'color: #28a745' : inspStatus === 'modified' ? 'color: #ffc107' : 'color: #ccc') + ';"></i><span class="inspection-label">검사확인</span></div>';
                }
                html += '</div></div>';
            }
            container.innerHTML = html;
        }
        
        function renderDevicePagination(data) {
            var nav = document.getElementById('device-pagination');
            if (!nav) return;
            var totalPages = data.totalPages || 1;
            if (totalPages <= 1) { nav.style.display = 'none'; return; }
            nav.style.display = '';
            var currentPage = data.currentPage || 1;
            var startPage = data.startPage || 1;
            var endPage = data.endPage || totalPages;
            var isMobile = window.innerWidth <= 768;
            if (isMobile) {
                startPage = Math.max(1, currentPage - 2);
                endPage = Math.min(totalPages, currentPage + 2);
            }
            var html = '<ul class="pagination">';
            html += '<li class="' + (startPage === 1 ? 'disabled' : '') + '"><a href="javascript:void(0);"' + (startPage > 1 ? ' data-page="' + (startPage - 1) + '" onclick="loadDeviceListApi(' + (startPage - 1) + '); return false;"' : '') + '>이전</a></li>';
            if (isMobile && startPage > 1) {
                html += '<li><a href="javascript:void(0);" data-page="1" onclick="loadDeviceListApi(1); return false;">1</a></li>';
                if (startPage > 2) html += '<li class="pagination-ellipsis"><span>…</span></li>';
            }
            for (var p = startPage; p <= endPage; p++) {
                html += '<li><a href="javascript:void(0);" data-page="' + p + '" class="' + (p === currentPage ? 'active' : '') + '" onclick="loadDeviceListApi(' + p + '); return false;">' + p + '</a></li>';
            }
            if (isMobile && endPage < totalPages) {
                if (endPage < totalPages - 1) html += '<li class="pagination-ellipsis"><span>…</span></li>';
                html += '<li><a href="javascript:void(0);" data-page="' + totalPages + '" onclick="loadDeviceListApi(' + totalPages + '); return false;">' + totalPages + '</a></li>';
            }
            html += '<li class="' + (endPage === totalPages ? 'disabled' : '') + '"><a href="javascript:void(0);"' + (endPage < totalPages ? ' data-page="' + (endPage + 1) + '" onclick="loadDeviceListApi(' + (endPage + 1) + '); return false;"' : '') + '>다음</a></li>';
            html += '</ul>';
            nav.innerHTML = html;
        }

        // 검사모드 관련 변수
        let isInspectionMode = false;
        let selectedSchoolForInspection = null;
        let inspectionData = {}; // 장비별 검사 상태 저장

        // 장비검사/장비목록 버튼용 - DOMContentLoaded 이전에 정의 (onclick에서 항상 호출 가능하도록)
        function openInspectionMode() {
            selectedSchoolForInspection = null;
            const dropdown = document.getElementById('schoolSelectDropdown');
            if (dropdown) {
                dropdown.innerHTML = '<option value="">학교를 선택하세요...</option>';
                dropdown.disabled = false;
            }
            loadSchoolsForInspection();
            const modal = document.getElementById('schoolSelectModal');
            if (modal) modal.style.display = 'flex';
        }
        function openDeviceList() {
            window.location.href = '/device/list';
        }
        function loadSchoolsForInspection() {
            fetch('/device/api/schools')
                .then(response => response.json())
                .then(schools => {
                    const schoolSelect = document.getElementById('schoolSelectDropdown');
                    const optionsContainer = document.getElementById('schoolSelectOptions');
                    const triggerText = document.querySelector('.school-select-trigger-text');
                    if (schoolSelect) {
                        schoolSelect.innerHTML = '<option value="">학교를 선택하세요...</option>';
                        (schools || []).forEach(school => {
                            const option = document.createElement('option');
                            option.value = String(school.schoolId);
                            option.textContent = school.schoolName;
                            schoolSelect.appendChild(option);
                        });
                    }
                    if (optionsContainer && triggerText) {
                        optionsContainer.innerHTML = '';
                        (schools || []).forEach(school => {
                            const div = document.createElement('div');
                            div.className = 'school-select-option';
                            div.setAttribute('data-school-id', String(school.schoolId));
                            div.textContent = school.schoolName;
                            optionsContainer.appendChild(div);
                        });
                        triggerText.textContent = '학교를 선택하세요...';
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // 페이지 로드 시 초기 교실 목록 설정 및 필터 change 이벤트 바인딩
        document.addEventListener('DOMContentLoaded', function() {
            const schoolSelect = document.getElementById('schoolSelect');
            const classroomSelect = document.getElementById('classroomSelect');
            const typeSelect = document.getElementById('typeSelect');
            const sortByPurposeCheckbox = document.getElementById('sortByPurposeCheckbox');
            const showUnusedOnlyCheckbox = document.getElementById('showUnusedOnlyCheckbox');
            // 필터 변경 시 API로 목록 갱신 (인라인 onchange 대신 여기서 바인딩)
            if (schoolSelect) {
                schoolSelect.addEventListener('change', function() {
                    updateClassroomsAndSubmit(this.value);
                });
                updateClassrooms(schoolSelect.value);
            }
            if (classroomSelect) {
                classroomSelect.addEventListener('change', function() {
                    updateSchoolIdAndSubmit();
                });
            }
            if (typeSelect) {
                typeSelect.addEventListener('change', function() {
                    updateSchoolIdAndSubmit();
                });
            }
            if (sortByPurposeCheckbox) {
                sortByPurposeCheckbox.addEventListener('change', function() {
                    handlePurposeSortChange();
                });
            }
            if (showUnusedOnlyCheckbox) {
                showUnusedOnlyCheckbox.addEventListener('change', function() {
                    handleUnusedOnlyChange();
                });
            }
            // 학교가 선택돼 있으면 항상 API로 목록 로드 (초기 로드·자동화·selectOption 후 change 미발생 대응)
            function loadListIfSchoolSelected() {
                var sel = document.getElementById('schoolSelect');
                if (sel && sel.value) {
                    loadDeviceListApi(1);
                }
            }
            setTimeout(loadListIfSchoolSelected, 100);
            setTimeout(loadListIfSchoolSelected, 600);
            setTimeout(loadListIfSchoolSelected, 1500);
            // 필터 폼 제출 시 전체 페이지 이동 방지, API로 목록 갱신
            const filterFormEl = document.getElementById('filterForm');
            if (filterFormEl) {
                filterFormEl.addEventListener('submit', function(e) {
                    e.preventDefault();
                    if (document.getElementById('device-tbody') && document.getElementById('schoolSelect') && document.getElementById('schoolSelect').value) {
                        loadDeviceListApi(1);
                    }
                });
            }
            // 검색 폼 제출 시 API로 목록 갱신 (전체 새로고침 없음)
            const searchForm = document.getElementById('searchForm');
            if (searchForm) {
                searchForm.addEventListener('submit', function(e) {
                    if (document.getElementById('device-tbody')) {
                        e.preventDefault();
                        var filterForm = document.getElementById('filterForm');
                        if (filterForm) {
                            var kw = document.getElementById('searchInput');
                            var hiddenKw = filterForm.querySelector('[name="searchKeyword"]');
                            if (kw && hiddenKw) hiddenKw.value = kw.value || '';
                        }
                        loadDeviceListApi(1);
                    }
                });
            }
            
            // 모바일: 검색 후 검색어가 있는 장비 카드로 스크롤
            const urlParams = new URLSearchParams(window.location.search);
            const searchKeywordParam = urlParams.get('searchKeyword');
            if (searchKeywordParam && searchKeywordParam.trim() !== '' && window.innerWidth <= 768) {
                const container = document.querySelector('.mobile-card-container');
                if (container) {
                    const firstHighlight = container.querySelector('.device-card .search-highlight');
                    const firstCard = firstHighlight ? firstHighlight.closest('.device-card') : container.querySelector('.device-card');
                    if (firstCard) {
                        setTimeout(function() {
                            firstCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 300);
                    }
                }
            }
            
            // 검사 모드 확인 및 초기화
            const inspectionMode = urlParams.get('inspectionMode');
            if (inspectionMode === 'true') {
                isInspectionMode = true;
                // DOM이 완전히 로드된 후 초기화 실행
                setTimeout(() => {
                    initializeInspectionMode();
                }, 100);
            }
            
            // 성공 메시지 자동 숨김 (5초 후)
            const successAlert = document.querySelector('.alert-success');
            if (successAlert) {
                setTimeout(() => {
                    successAlert.style.display = 'none';
                }, 5000);
            }
            
            // 로컬스토리지에서 체크박스 상태 복원 (QR코드는 이미 복원됨)
            loadCheckboxStates();
            
            // QR코드검색 체크박스 이벤트 (상태 유지) + 검색창 포커스 제어
            const qrCodeSearchCheckbox = document.getElementById('qrCodeSearch');
            const searchInput = document.getElementById('searchInput');
            
            // QR 모드에서 포커스를 잠시 허용할 예외 요소들 (검사 체크박스, 필터 셀렉트 등)
            function isQrFocusExceptionElement(el) {
                if (!el) return false;
                return el.closest('.inspection-checkbox')
                    || el.closest('.inspection-checkbox-mobile')
                    || el.closest('#schoolSelect')
                    || el.closest('#classroomSelect')
                    || el.closest('select[name="type"]')
                    || el.closest('.purpose-sort-checkbox')
                    || el.closest('.search-options')
                    || el.closest('.search-btn')
                    || el.closest('.qr-scan-btn')
                    || el.closest('#qrScanModal');
            }
            
            function handleQrSearchBlur(e) {
                if (!qrCodeSearchCheckbox || !searchInput) return;
                if (!qrCodeSearchCheckbox.checked) return;
                // blur 시 포커스를 받는 쪽(relatedTarget)이 예외 요소면 되돌리지 않음
                var toEl = e && e.relatedTarget;
                if (isQrFocusExceptionElement(toEl)) {
                    return;
                }
                setTimeout(function() { searchInput.focus({ preventScroll: true }); }, 0);
            }
            function enableQrFocusLock() {
                if (!searchInput) return;
                searchInput.focus({ preventScroll: true });
                searchInput.addEventListener('blur', handleQrSearchBlur);
            }
            function disableQrFocusLock() {
                if (!searchInput) return;
                searchInput.removeEventListener('blur', handleQrSearchBlur);
            }
            if (qrCodeSearchCheckbox && searchInput) {
                qrCodeSearchCheckbox.addEventListener('change', function() {
                    localStorage.setItem('qrCodeSearch', this.checked.toString());
                    if (this.checked) {
                        enableQrFocusLock();
                    } else {
                        disableQrFocusLock();
                    }
                });
                // 이미 체크된 상태이거나 저장된 상태가 true이면 포커스 잠금 활성화
                const savedQrCodeSearch = localStorage.getItem('qrCodeSearch');
                if (savedQrCodeSearch === 'true' || qrCodeSearchCheckbox.checked) {
                    qrCodeSearchCheckbox.checked = true;
                    enableQrFocusLock();
                }
                // QR코드검색 모드일 때 검색 후 검색어를 남기지 않고 비움
                if (qrCodeSearchCheckbox.checked && searchInput) {
                    searchInput.value = '';
                }
            }
            
            // 장비가 있는 교실 체크박스 이벤트
            document.getElementById('showClassroomsWithDevices').addEventListener('change', function() {
                localStorage.setItem('showClassroomsWithDevices', this.checked.toString());
                filterDevicesByClassroom();
            });
            
            // 검색 결과가 있으면 첫 번째 강조(빨간글씨)를 화면 중앙으로 스크롤 (모바일·태블릿 포함)
            var scrollDelay = (window.innerWidth < 1024) ? 300 : 150;
            setTimeout(function() {
                var first = document.querySelector('.search-highlight');
                if (first) {
                    try {
                        first.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } catch (e) {
                        first.scrollIntoView(true);
                    }
                }
            }, scrollDelay);
            
            // 검색어 입력 이벤트는 제거 (타이핑할 때마다 폼 제출 방지)
        });
        
        // 체크박스 상태 로드 (페이지 로드 시에만)
        function loadCheckboxStates() {
            // localStorage에서 저장된 상태 복원
            const savedQrCodeSearch = localStorage.getItem('qrCodeSearch');
            const savedShowClassroomsWithDevices = localStorage.getItem('showClassroomsWithDevices');
            
            // QR코드검색 체크박스 상태 설정 (이미 복원되었을 수 있으므로 확인 후 설정)
            const qrCodeSearchCheckbox = document.getElementById('qrCodeSearch');
            if (qrCodeSearchCheckbox && savedQrCodeSearch !== null) {
                // 체크 상태가 다르면 업데이트
                const shouldBeChecked = savedQrCodeSearch === 'true';
                if (qrCodeSearchCheckbox.checked !== shouldBeChecked) {
                    qrCodeSearchCheckbox.checked = shouldBeChecked;
                }
            }
            
            // 장비가 있는 교실 체크박스 상태 설정
            const serverShowClassroomsWithDevices = /*[[${showClassroomsWithDevices}]]*/ false;
            const checkboxElement = document.getElementById('showClassroomsWithDevices');
            
            // 서버에서 값을 받은 경우 localStorage에 저장
            if (serverShowClassroomsWithDevices !== null && serverShowClassroomsWithDevices !== undefined) {
                localStorage.setItem('showClassroomsWithDevices', serverShowClassroomsWithDevices.toString());
            } else if (savedShowClassroomsWithDevices !== null) {
                // 서버 값이 없으면 localStorage에서 로드
                checkboxElement.checked = savedShowClassroomsWithDevices === 'true';
            }
            
            // 검색 폼과 필터 폼의 hidden input에도 체크박스 상태 설정
            const searchShowClassroomsInput = document.getElementById('searchShowClassroomsWithDevices');
            const filterShowClassroomsInput = document.getElementById('filterShowClassroomsWithDevices');
            const checkboxChecked = document.getElementById('showClassroomsWithDevices').checked;
            
            if (searchShowClassroomsInput) {
                searchShowClassroomsInput.value = checkboxChecked ? 'true' : '';
            }
            if (filterShowClassroomsInput) {
                filterShowClassroomsInput.value = checkboxChecked ? 'true' : '';
            }
            
            // 페이지 로드 시에는 서버에서 이미 필터링된 데이터를 받아왔으므로 클라이언트 필터링 불필요
            
            // 검사 모드가 아닐 때 inspectionMode 파라미터 제거
            if (!isInspectionMode) {
                document.getElementById('inspectionModeParam').value = '';
                document.getElementById('filterInspectionModeParam').value = '';
            }
        }
        
        // 교실별 장비 필터링 함수 (장비가 있는 교실 체크 시 API로 목록 갱신)
        function filterDevicesByClassroom() {
            const showClassroomsWithDevices = document.getElementById('showClassroomsWithDevices').checked;
            const filterShowClassroomsInput = document.getElementById('filterShowClassroomsWithDevices');
            const searchShowClassroomsInput = document.getElementById('searchShowClassroomsWithDevices');
            if (filterShowClassroomsInput) filterShowClassroomsInput.value = showClassroomsWithDevices ? 'true' : '';
            if (searchShowClassroomsInput) searchShowClassroomsInput.value = showClassroomsWithDevices ? 'true' : '';
            if (document.getElementById('device-tbody')) {
                loadDeviceListApi(1);
            } else {
                document.getElementById('searchForm').submit();
            }
        }
        
        // 모든 장비 표시 함수
        function showAllDevices() {
            const deviceRows = document.querySelectorAll('tbody tr');
            deviceRows.forEach(row => {
                row.style.display = '';
            });
        }
        
        // 학교 선택 모달 이벤트
        const schoolSelectDropdownEl = document.getElementById('schoolSelectDropdown');
        if (schoolSelectDropdownEl) {
            schoolSelectDropdownEl.addEventListener('change', function() {
                selectedSchoolForInspection = this.value;
            });
        }
        document.getElementById('cancelSchoolSelect').addEventListener('click', function() {
            document.getElementById('schoolSelectModal').style.display = 'none';
            selectedSchoolForInspection = null;
        });
        
        document.getElementById('confirmSchoolSelect').addEventListener('click', function() {
            if (!selectedSchoolForInspection) {
                alert('학교를 선택해주세요.');
                return;
            }
            
            // 검사모드 진입
            enterInspectionMode(selectedSchoolForInspection);
            document.getElementById('schoolSelectModal').style.display = 'none';
        });
        
        // 커스텀 학교 선택 드롭다운 (모바일 스크롤 가능)
        const schoolSelectCustom = document.getElementById('schoolSelectCustom');
        const schoolSelectTrigger = document.getElementById('schoolSelectTrigger');
        const schoolSelectOptions = document.getElementById('schoolSelectOptions');
        if (schoolSelectTrigger && schoolSelectOptions && schoolSelectCustom) {
            schoolSelectTrigger.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                schoolSelectCustom.classList.toggle('open');
                schoolSelectTrigger.setAttribute('aria-expanded', schoolSelectCustom.classList.contains('open'));
            });
            schoolSelectOptions.addEventListener('click', function(e) {
                const option = e.target.closest('.school-select-option');
                if (!option) return;
                const schoolId = option.getAttribute('data-school-id');
                const schoolName = option.textContent;
                selectedSchoolForInspection = schoolId;
                const triggerText = schoolSelectTrigger.querySelector('.school-select-trigger-text');
                if (triggerText) triggerText.textContent = schoolName;
                const nativeSelect = document.getElementById('schoolSelectDropdown');
                if (nativeSelect) {
                    nativeSelect.value = schoolId;
                    nativeSelect.dispatchEvent(new Event('change'));
                }
                schoolSelectOptions.querySelectorAll('.school-select-option').forEach(function(el) { el.classList.remove('selected'); });
                option.classList.add('selected');
                schoolSelectCustom.classList.remove('open');
                schoolSelectTrigger.setAttribute('aria-expanded', 'false');
            });
            document.getElementById('schoolSelectModal').addEventListener('click', function(e) {
                if (schoolSelectCustom.classList.contains('open') && !e.target.closest('.school-select-custom')) {
                    schoolSelectCustom.classList.remove('open');
                    schoolSelectTrigger.setAttribute('aria-expanded', 'false');
                }
            });
        }
        
        // 검사모드 진입
        function enterInspectionMode(schoolId) {
            isInspectionMode = true;
            
            // 학교 필터링을 위해 페이지 리로드
            const url = new URL(window.location);
            url.searchParams.set('schoolId', schoolId);
            url.searchParams.set('inspectionMode', 'true');
            window.location.href = url.toString();
        }
        
        // 검사모드 초기화
        function initializeInspectionMode() {
            // 검사 모드 파라미터 설정 (UI는 서버에서 이미 렌더링됨)
            const inspectionModeParam = document.getElementById('inspectionModeParam');
            const filterInspectionModeParam = document.getElementById('filterInspectionModeParam');
            if (inspectionModeParam) inspectionModeParam.value = 'true';
            if (filterInspectionModeParam) filterInspectionModeParam.value = 'true';
            
            // 검사 데이터 초기화
            inspectionData = {};
            
            // 저장된 검사 상태 로드
            loadInspectionStatuses();
        }
        
        // 저장된 검사 상태 로드
        function loadInspectionStatuses() {
            const urlParams = new URLSearchParams(window.location.search);
            const schoolId = urlParams.get('schoolId');
            
            console.log('검사 상태 로드 시작, schoolId:', schoolId);
            
            if (!schoolId) {
                console.error('학교 정보를 찾을 수 없습니다.');
                return;
            }
            
            fetch(`/device/inspection/status/load?schoolId=${schoolId}`)
                .then(response => response.json())
                .then(data => {
                    console.log('검사 상태 로드 응답:', data);
                    if (data.success && data.statuses) {
                        console.log('저장된 검사 상태들:', data.statuses);
                        
                        // DOM이 완전히 로드될 때까지 기다린 후 상태 복원 (카드 렌더링 대기)
                        let retryCount = 0;
                        const maxRetries = 10;
                        const retryInterval = 200;
                        
                        const tryApplyStatuses = () => {
                            const cardElements = document.querySelectorAll('.inspection-checkbox-mobile, .inspection-checkbox');
                            if (cardElements.length > 0 || retryCount >= maxRetries) {
                                console.log(`검사 상태 적용 시도 (재시도: ${retryCount}, 요소 수: ${cardElements.length})`);
                            applyInspectionStatuses(data.statuses);
                            } else {
                                retryCount++;
                                console.log(`검사 상태 적용 대기 중... (${retryCount}/${maxRetries})`);
                                setTimeout(tryApplyStatuses, retryInterval);
                            }
                        };
                        
                        setTimeout(tryApplyStatuses, 100);
                    } else {
                        console.log('저장된 검사 상태가 없습니다.');
                    }
                })
                .catch(error => {
                    console.error('검사 상태 로드 중 오류:', error);
                });
        }
        
        // 검사 상태를 UI에 적용
        function applyInspectionStatuses(statuses) {
            let restoredCount = 0;
            let notFoundCount = 0;
            
            Object.entries(statuses).forEach(([deviceId, status]) => {
                const element = document.querySelector(`[data-device-id="${deviceId}"]`);
                if (element) {
                    const icon = element.querySelector('.inspection-icon');
                    if (icon) {
                        inspectionData[deviceId] = status;
                        restoredCount++;
                        
                        console.log(`장비 ${deviceId} 상태 복원: ${status}`);
                        
                        // 아이콘 및 버튼 배경 상태 설정
                        switch(status) {
                            case 'confirmed':
                                icon.className = 'fas fa-check-circle inspection-icon confirmed';
                                icon.style.color = '#28a745';
                                break;
                            case 'modified':
                                icon.className = 'fas fa-check-circle inspection-icon modified';
                                icon.style.color = '#ffc107';
                                break;
                            case 'unchecked':
                            default:
                                icon.className = 'fas fa-check-circle inspection-icon unchecked';
                                icon.style.color = '#ccc';
                                break;
                        }
                        // 버튼 배경 상태 클래스 적용 (모바일/태블릿 카드 버튼)
                        element.classList.remove('state-unchecked', 'state-confirmed', 'state-modified');
                        element.classList.add('state-' + status);
                    } else {
                        console.warn(`장비 ${deviceId}의 아이콘 요소를 찾을 수 없습니다.`);
                        notFoundCount++;
                    }
                } else {
                    // DOM에 없는 장비는 현재 페이지에 표시되지 않는 장비이므로 정상적인 상황
                    notFoundCount++;
                }
            });
            
            console.log(`검사 상태 복원 완료: ${restoredCount}개 복원, ${notFoundCount}개는 현재 페이지에 없음`);
        }
        
        // 검사모드 종료
        function exitInspectionMode() {
            // 실시간 저장으로 인해 저장하지 않은 데이터가 없으므로 확인 메시지 제거
            
            isInspectionMode = false;
            
            // UI 복원
            var inspectionModeBtn = document.getElementById('inspectionModeBtn');
            var inspectionHistoryBtn = document.getElementById('inspectionHistoryBtn');
            var qrDownloadBtn = document.getElementById('qrDownloadBtn');
            var inspectionStatusBtn = document.getElementById('inspectionStatusBtn');
            if (inspectionModeBtn) inspectionModeBtn.style.display = 'inline-block';
            if (inspectionHistoryBtn) inspectionHistoryBtn.style.display = 'none';
            if (qrDownloadBtn) qrDownloadBtn.style.display = '';
            if (inspectionStatusBtn) inspectionStatusBtn.style.display = 'none';
            document.getElementById('inspectionColumn').style.display = 'none';
            document.getElementById('inspectionModeButtons').style.display = 'none';
            
            // 모든 검사확인 셀 숨기기
            document.querySelectorAll('#inspectionCell').forEach(cell => {
                cell.style.display = 'none';
            });
            
            // 학교 선택 활성화
            document.getElementById('schoolSelect').disabled = false;
            
            // 검사 데이터 초기화
            inspectionData = {};
        }
        
        // 검사 상태 UI만 설정 (토글/되돌리기 공용)
        function setInspectionUIState(element, status) {
            if (!element) return;
            var deviceId = element.dataset.deviceId;
            var icon = element.querySelector('.inspection-icon');
            if (!deviceId || !icon) return;
            inspectionData[deviceId] = status;
            if (status === 'confirmed') {
                icon.className = 'fas fa-check-circle inspection-icon confirmed';
                icon.style.color = '#28a745';
            } else if (status === 'modified') {
                icon.className = 'fas fa-check-circle inspection-icon modified';
                icon.style.color = '#ffc107';
            } else {
                icon.className = 'fas fa-check-circle inspection-icon unchecked';
                icon.style.color = '#ccc';
            }
            element.classList.remove('state-unchecked', 'state-confirmed', 'state-modified');
            element.classList.add('state-' + status);
        }
        
        // 검사 상태 토글
        function toggleInspection(element) {
            var deviceId = element.dataset.deviceId;
            if (!deviceId) return;
            var currentState = inspectionData[deviceId] || 'unchecked';
            var previousState = currentState;
            var nextState = (previousState === 'unchecked') ? 'confirmed' : (previousState === 'confirmed') ? 'modified' : 'unchecked';
            setInspectionUIState(element, nextState);
            saveInspectionStatusToServer(deviceId, nextState, previousState, element);
        }
        
        // 검사 상태를 서버 API로 저장 (실패 시 UI 되돌리기)
        function saveInspectionStatusToServer(deviceId, status, previousState, element) {
            var schoolSelect = document.getElementById('schoolSelect');
            var schoolId = (schoolSelect && schoolSelect.value) ? schoolSelect.value.trim() : '';
            if (!schoolId) {
                var urlParams = new URLSearchParams(window.location.search);
                schoolId = urlParams.get('schoolId') || '';
            }
            if (!schoolId) {
                if (element) setInspectionUIState(element, previousState);
                if (typeof alert !== 'undefined') alert('학교를 선택한 후 검사 상태를 저장할 수 있습니다.');
                return;
            }
            fetch('/device/inspection/status/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ deviceId: Number(deviceId), schoolId: Number(schoolId), status: status })
            })
            .then(function(response) {
                return response.json()
                    .then(function(data) {
                        if (!response.ok) {
                            data.success = false;
                            if (!data.message) data.message = '저장 요청이 실패했습니다. (HTTP ' + response.status + ')';
                        }
                        return data;
                    })
                    .catch(function() {
                        return { success: false, message: '저장 요청이 실패했습니다. (HTTP ' + response.status + ')' };
                    });
            })
            .then(function(data) {
                if (!data.success) {
                    if (element) setInspectionUIState(element, previousState);
                    if (typeof alert !== 'undefined') alert(data.message || '검사 상태 저장에 실패했습니다.');
                }
            })
            .catch(function(err) {
                if (element) setInspectionUIState(element, previousState);
                if (typeof alert !== 'undefined') alert('검사 상태 저장 중 오류가 발생했습니다. 네트워크를 확인해 주세요.');
            });
        }
        
        // 검사 저장 함수 제거 - 실시간 저장으로 대체됨
        
        // 검사 초기화
        function resetInspection() {
            if (!confirm('모든 검사 정보가 초기화됩니다. 정말 초기화하시겠습니까?')) {
                return;
            }
            
            console.log('검사 초기화 시작');
            
            // 모든 체크박스를 미확인 상태로 변경하고 서버에 저장 (데스크톱 + 모바일)
            const checkboxes = document.querySelectorAll('.inspection-checkbox, .inspection-checkbox-mobile');
            console.log(`초기화할 체크박스 개수: ${checkboxes.length}`);
            
            let resetCount = 0;
            checkboxes.forEach(checkbox => {
                const deviceId = checkbox.dataset.deviceId;
                const icon = checkbox.querySelector('.inspection-icon');
                
                if (deviceId && icon) {
                    // UI 업데이트
                    icon.className = 'fas fa-check-circle inspection-icon unchecked';
                    // 버튼 배경 상태 초기화
                    if (checkbox.classList) {
                        checkbox.classList.remove('state-confirmed','state-modified');
                        checkbox.classList.add('state-unchecked');
                    }
                    
                    // 검사 데이터 업데이트
                    inspectionData[deviceId] = 'unchecked';
                    
                    // 서버에 초기화 상태 저장 (되돌리기 없음)
                    saveInspectionStatusToServer(deviceId, 'unchecked', null, null);
                    resetCount++;
                } else {
                    console.warn('체크박스에서 deviceId 또는 icon을 찾을 수 없습니다:', checkbox);
                }
            });
            
            console.log(`초기화 완료: ${resetCount}개 장비`);
            
            // 초기화 완료 메시지
            setTimeout(() => {
                alert('모든 검사 정보가 초기화되었습니다.');
            }, 500);
        }
        
        // QR코드검색 모드: 입력/붙여넣기 시 자동 검색 제거. 엔터 또는 검색 버튼으로만 검색.
        
        // 현재 필터 값으로 엑셀 다운로드 URL 생성 (화면에 선택된 학교/교실/타입 반영)
        // override: { schoolId, type, classroomId } 검사 모드 등에서 DOM 대신 사용할 값
        function getExcelDownloadUrl(override) {
            const schoolSelectEl = document.getElementById('schoolSelect');
            const typeSelectEl = document.getElementById('typeSelect');
            const classroomSelectEl = document.getElementById('classroomSelect');
            const sortByPurposeHidden = document.getElementById('sortByPurposeHidden');
            let schoolId = override && override.schoolId != null ? String(override.schoolId).trim() : (schoolSelectEl && schoolSelectEl.value ? schoolSelectEl.value.trim() : '');
            let type = override && override.type != null ? String(override.type).trim() : (typeSelectEl && typeSelectEl.value ? typeSelectEl.value.trim() : '');
            let classroomId = override && override.classroomId != null ? String(override.classroomId).trim() : (classroomSelectEl && classroomSelectEl.value ? classroomSelectEl.value.trim() : '');
            const sortByPurpose = sortByPurposeHidden && sortByPurposeHidden.value === 'true';
            const params = [];
            if (schoolId) params.push('schoolId=' + encodeURIComponent(schoolId));
            if (type) params.push('type=' + encodeURIComponent(type));
            if (classroomId) params.push('classroomId=' + encodeURIComponent(classroomId));
            if (sortByPurpose) params.push('sortByPurpose=true');
            return '/device/excel' + (params.length ? '?' + params.join('&') : '');
        }
        
        // 엑셀 실패 시 서버 응답을 콘솔에 남기고 알림용 메시지 반환 (원인 파악용)
        function formatDeviceExcelError(status, text, requestUrl) {
            console.error('[장비목록 엑셀] 실패 URL:', requestUrl);
            console.error('[장비목록 엑셀] HTTP 상태:', status);
            console.error('[장비목록 엑셀] 서버 응답 본문:', text);
            if (!text || !text.trim()) return '엑셀 다운로드 실패 (HTTP ' + status + ')';
            var t = text.trim();
            if (t.length > 400 || t.indexOf('<') === 0 || t.toLowerCase().indexOf('<!doctype') === 0) {
                return '엑셀 다운로드 실패 (HTTP ' + status + '). 원인은 개발자 도구 콘솔을 확인하세요.';
            }
            return t;
        }
        
        // 엑셀 다운로드 (검사 데이터 포함)
        function downloadExcelWithInspection(event) {
            if (event) {
                event.preventDefault();
            }
            
            // 화면 중간에 로딩 오버레이 표시
            const loadingOverlay = document.getElementById('excelLoadingOverlay');
            console.log('로딩 오버레이 요소:', loadingOverlay);
            if (loadingOverlay) {
                loadingOverlay.style.setProperty('display', 'flex', 'important');
                console.log('로딩 오버레이 표시됨');
            } else {
                console.error('로딩 오버레이 요소를 찾을 수 없습니다!');
                // 요소가 없으면 동적으로 생성
                const newOverlay = document.createElement('div');
                newOverlay.id = 'excelLoadingOverlay';
                newOverlay.className = 'excel-loading-overlay';
                newOverlay.innerHTML = '<div class="excel-loading-content"><i class="fas fa-spinner fa-spin"></i><span>엑셀 다운로드 중</span></div>';
                document.body.appendChild(newOverlay);
                newOverlay.style.setProperty('display', 'flex', 'important');
            }
            
            // 버튼 비활성화
            const excelBtn = document.getElementById('excelDownloadBtn');
            if (excelBtn) {
            excelBtn.style.pointerEvents = 'none';
            }
            if (isInspectionMode) {
                // 검사모드인 경우 서버에서 검사 상태를 가져와서 엑셀 다운로드
                const schoolSelectElement = document.getElementById('schoolSelect');
                const schoolId = selectedSchoolForInspection || (schoolSelectElement ? schoolSelectElement.value : null);
                
                if (schoolId) {
                    // 서버에서 검사 상태를 가져와서 엑셀 다운로드
                    console.log('검사 상태 로드 시작, schoolId:', schoolId);
                    fetch(`/device/inspection/status/load?schoolId=${schoolId}`)
                        .then(response => response.json())
                        .then(inspectionStatuses => {
                            console.log('받은 검사 상태:', inspectionStatuses);
                            // 검사 상태가 있는 경우에만 검사 데이터를 포함한 엑셀 다운로드
                            if (Object.keys(inspectionStatuses).length > 0) {
                                console.log('검사 데이터를 포함한 엑셀 다운로드 시작');
                                
                                // FormData 생성
                                const formData = new FormData();
                                formData.append('inspectionData', JSON.stringify(inspectionStatuses));
                                formData.append('schoolId', schoolId);
                                
                                // 안전하게 DOM 요소 접근
                                const typeSelectElement = document.getElementById('typeSelect');
                                const typeValue = typeSelectElement ? typeSelectElement.value : '';
                                formData.append('type', typeValue);
                                
                                const classroomSelectElement = document.getElementById('classroomSelect');
                                const classroomIdValue = classroomSelectElement ? classroomSelectElement.value : '';
                                formData.append('classroomId', classroomIdValue);
                                
                                // fetch를 사용하여 엑셀 다운로드
                                var inspectionExcelUrl = '/device/excel/inspection';
                                fetch(inspectionExcelUrl, {
                                    method: 'POST',
                                    body: formData
                                })
                                .then(response => {
                                    if (!response.ok) {
                                        return response.text().then(text => {
                                            throw new Error(formatDeviceExcelError(response.status, text, inspectionExcelUrl));
                                        });
                                    }
                                    return response.blob();
                                })
                                .then(blob => {
                                    // Blob URL 생성
                                    const url = window.URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = '장비목록.xlsx';
                                    document.body.appendChild(a);
                                    a.click();
                                    document.body.removeChild(a);
                                    window.URL.revokeObjectURL(url);
                                    
                                    // 다운로드 완료 후 로딩 오버레이 숨김 및 버튼 복원
                                    if (loadingOverlay) {
                                        loadingOverlay.style.display = 'none';
                                    }
                                    if (excelBtn) {
                                        excelBtn.style.pointerEvents = '';
                                    }
                                })
                                .catch(error => {
                                    console.error('엑셀 다운로드 오류:', error);
                                    if (loadingOverlay) {
                                        loadingOverlay.style.display = 'none';
                                    }
                                    if (excelBtn) {
                                        excelBtn.style.pointerEvents = '';
                                    }
                                    alert('엑셀 다운로드 실패: ' + (error.message || '알 수 없는 오류'));
                                });
                            } else {
                                // 검사 상태가 없는 경우 일반 엑셀 다운로드 (선택된 학교/현재 필터 기준 URL)
                                const excelBtn = document.getElementById('excelDownloadBtn');
                                const loadingOverlay = document.getElementById('excelLoadingOverlay');
                                const typeSelectElement = document.getElementById('typeSelect');
                                const classroomSelectElement = document.getElementById('classroomSelect');
                                const downloadUrl = getExcelDownloadUrl({
                                    schoolId: schoolId,
                                    type: typeSelectElement ? typeSelectElement.value : '',
                                    classroomId: classroomSelectElement ? classroomSelectElement.value : ''
                                });
                                console.log('[장비목록 엑셀] 요청 URL:', downloadUrl);
                                fetch(downloadUrl)
                                    .then(response => {
                                        if (!response.ok) {
                                            return response.text().then(text => {
                                                throw new Error(formatDeviceExcelError(response.status, text, downloadUrl));
                                            });
                                        }
                                        return response.blob();
                                    })
                                    .then(blob => {
                                        // Blob URL 생성
                                        const url = window.URL.createObjectURL(blob);
                                        const a = document.createElement('a');
                                        a.href = url;
                                        a.download = '장비목록.xlsx';
                                        document.body.appendChild(a);
                                        a.click();
                                        document.body.removeChild(a);
                                        window.URL.revokeObjectURL(url);
                                        
                                        // 다운로드 완료 후 로딩 오버레이 숨김 및 버튼 복원
                                        if (loadingOverlay) {
                                            loadingOverlay.style.display = 'none';
                                        }
                                        if (excelBtn) {
                                            excelBtn.style.pointerEvents = '';
                                        }
                                    })
                                    .catch(error => {
                                    console.error('엑셀 다운로드 오류:', error);
                                    if (loadingOverlay) {
                                        loadingOverlay.style.display = 'none';
                                    }
                                    if (excelBtn) {
                                        excelBtn.style.pointerEvents = '';
                                }
                                    alert('엑셀 다운로드 실패: ' + (error.message || '알 수 없는 오류'));
                                    });
                            }
                        })
                        .catch(error => {
                            console.error('검사 상태 로드 중 오류:', error);
                            // 오류 발생 시 일반 엑셀 다운로드 (현재 필터 기준 URL 사용)
                            const excelBtn = document.getElementById('excelDownloadBtn');
                            const loadingOverlay = document.getElementById('excelLoadingOverlay');
                            const downloadUrl = getExcelDownloadUrl();
                            console.log('[장비목록 엑셀] 요청 URL:', downloadUrl);
                            fetch(downloadUrl)
                                .then(response => {
                                    if (!response.ok) {
                                        return response.text().then(text => {
                                            throw new Error(formatDeviceExcelError(response.status, text, downloadUrl));
                                        });
                                    }
                                    return response.blob();
                                })
                                .then(blob => {
                                    // Blob URL 생성
                                    const url = window.URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = '장비목록.xlsx';
                                    document.body.appendChild(a);
                                    a.click();
                                    document.body.removeChild(a);
                                    window.URL.revokeObjectURL(url);
                                    
                                    // 다운로드 완료 후 로딩 오버레이 숨김 및 버튼 복원
                                    const loadingOverlay = document.getElementById('excelLoadingOverlay');
                                    if (loadingOverlay) {
                                        loadingOverlay.style.display = 'none';
                                    }
                                    if (excelBtn) {
                                        excelBtn.style.pointerEvents = '';
                                    }
                                })
                                .catch(downloadError => {
                                    console.error('엑셀 다운로드 오류:', downloadError);
                                    const loadingOverlay = document.getElementById('excelLoadingOverlay');
                                    if (loadingOverlay) {
                                        loadingOverlay.style.display = 'none';
                                    }
                                    if (excelBtn) {
                                        excelBtn.style.pointerEvents = '';
                            }
                                    alert('엑셀 다운로드 실패: ' + (downloadError.message || '알 수 없는 오류'));
                                });
                        });
                } else {
                    // 학교가 선택되지 않은 경우 일반 엑셀 다운로드 (현재 필터 기준 URL 사용)
                    const excelBtn = document.getElementById('excelDownloadBtn');
                    const loadingOverlay = document.getElementById('excelLoadingOverlay');
                    const downloadUrl = getExcelDownloadUrl();
                    console.log('[장비목록 엑셀] 요청 URL:', downloadUrl);
                    fetch(downloadUrl)
                        .then(response => {
                            if (!response.ok) {
                                return response.text().then(text => {
                                    throw new Error(formatDeviceExcelError(response.status, text, downloadUrl));
                                });
                            }
                            return response.blob();
                        })
                        .then(blob => {
                            // Blob URL 생성
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = '장비목록.xlsx';
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                            
                            // 다운로드 완료 후 로딩 오버레이 숨김 및 버튼 복원
                            if (loadingOverlay) {
                                loadingOverlay.style.display = 'none';
                            }
                            if (excelBtn) {
                            excelBtn.style.pointerEvents = '';
                            }
                        })
                        .catch(error => {
                            console.error('엑셀 다운로드 오류:', error);
                            if (loadingOverlay) {
                                loadingOverlay.style.display = 'none';
                            }
                            if (excelBtn) {
                            excelBtn.style.pointerEvents = '';
                    }
                            alert('엑셀 다운로드 실패: ' + (error.message || '알 수 없는 오류'));
                        });
                }
            } else {
                // 일반 모드: 현재 화면 필터(학교/교실/타입) 기준으로 엑셀 다운로드
                const excelBtn = document.getElementById('excelDownloadBtn');
                const loadingOverlay = document.getElementById('excelLoadingOverlay');
                const downloadUrl = getExcelDownloadUrl();
                console.log('[장비목록 엑셀] 요청 URL:', downloadUrl);
                fetch(downloadUrl)
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => {
                                throw new Error(formatDeviceExcelError(response.status, text, downloadUrl));
                            });
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        // Blob URL 생성
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = '장비목록.xlsx'; // 다운로드 파일명
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        
                        // 다운로드 완료 후 로딩 오버레이 숨김 및 버튼 복원
                        if (loadingOverlay) {
                            loadingOverlay.style.display = 'none';
                        }
                        if (excelBtn) {
                        excelBtn.style.pointerEvents = '';
                        }
                    })
                    .catch(error => {
                        console.error('엑셀 다운로드 오류:', error);
                        // 오류 발생 시 로딩 오버레이 숨김 및 버튼 복원
                        if (loadingOverlay) {
                            loadingOverlay.style.display = 'none';
                        }
                        if (excelBtn) {
                        excelBtn.style.pointerEvents = '';
                        }
                        alert('엑셀 다운로드 실패: ' + (error.message || '알 수 없는 오류'));
                    });
            }
        }
        
        // 검사현황 모달 열기
        function openInspectionStatusModal() {
            var schoolSelect = document.getElementById('schoolSelect');
            var schoolId = (schoolSelect && schoolSelect.value) ? schoolSelect.value.trim() : '';
            if (!schoolId) {
                var params = new URLSearchParams(window.location.search);
                schoolId = params.get('schoolId') || '';
            }
            if (!schoolId) {
                alert('학교를 선택해주세요.');
                return;
            }
            var modal = document.getElementById('inspectionStatusModal');
            if (modal) {
                modal.style.display = 'block';
                loadInspectionStatusSummary(schoolId);
            }
        }
        function closeInspectionStatusModal() {
            var modal = document.getElementById('inspectionStatusModal');
            if (modal) modal.style.display = 'none';
        }
        function loadInspectionStatusSummary(schoolId) {
            var classroomSelect = document.getElementById('classroomSelect');
            var typeSelect = document.querySelector('select[name="type"]');
            var classroomId = (classroomSelect && classroomSelect.value) ? classroomSelect.value : '';
            var type = (typeSelect && typeSelect.value) ? typeSelect.value : '';
            var url = '/device/api/inspection-status-summary?schoolId=' + encodeURIComponent(schoolId);
            if (classroomId) url += '&classroomId=' + encodeURIComponent(classroomId);
            if (type) url += '&type=' + encodeURIComponent(type);
            fetch(url)
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (!data.success) {
                        alert(data.message || '검사 현황 조회에 실패했습니다.');
                        return;
                    }
                    inspectionStatusPage = 1;
                    renderInspectionStatusTable(data.classrooms || []);
                })
                .catch(function(err) {
                    console.error(err);
                    alert('검사 현황 조회 중 오류가 발생했습니다.');
                });
        }
        var inspectionStatusData = [];
        var inspectionStatusPage = 1;
        var INSPECTION_STATUS_PAGE_SIZE = 12;
        function renderInspectionStatusTable(classrooms) {
            if (classrooms !== undefined) inspectionStatusData = classrooms || [];
            var sortOrder = document.getElementById('inspectionStatusSortSelect');
            if (sortOrder) sortOrder = sortOrder.value;
            sortOrder = sortOrder || 'classroom';
            var sorted = inspectionStatusData.slice();
            if (sortOrder === 'status') {
                function getStatusOrder(c) {
                    var s = (c.statusColor || '').toString().toLowerCase().trim();
                    if (s === 'red') return 0;
                    if (s === 'orange') return 1;
                    if (s === 'green') return 2;
                    return 3;
                }
                sorted.sort(function(a, b) {
                    var diff = getStatusOrder(a) - getStatusOrder(b);
                    if (diff !== 0) return diff;
                    return (a.classroomName || '').localeCompare(b.classroomName || ''); 
                });
            } else {
                sorted.sort(function(a, b) { return (a.classroomName || '').localeCompare(b.classroomName || ''); });
            }
            var totalItems = sorted.length;
            var totalPages = Math.max(1, Math.ceil(totalItems / INSPECTION_STATUS_PAGE_SIZE));
            if (inspectionStatusPage > totalPages) inspectionStatusPage = totalPages;
            var fromIdx = (inspectionStatusPage - 1) * INSPECTION_STATUS_PAGE_SIZE;
            var toIdx = Math.min(fromIdx + INSPECTION_STATUS_PAGE_SIZE, totalItems);
            var pageData = sorted.slice(fromIdx, toIdx);
            var tbody = document.getElementById('inspectionStatusTableBody');
            if (!tbody) return;
            var html = '';
            for (var i = 0; i < pageData.length; i++) {
                var c = pageData[i];
                var sc = (c.statusColor || '').toString().toLowerCase().trim();
                var colorClass = sc === 'red' ? 'status-red' : (sc === 'orange' ? 'status-orange' : 'status-green');
                html += '<tr><td>' + escapeHtml(c.classroomName || '') + '</td><td><span class="inspection-status-number">' + c.deviceCount + '</span></td><td><span class="inspection-status-number">' + c.checkedCount + '</span></td><td><span class="inspection-status-dot ' + colorClass + '"></span></td></tr>';
            }
            tbody.innerHTML = html || '<tr><td colspan="4" style="text-align:center;color:#6c757d;">검사 현황이 없습니다.</td></tr>';
            var paginationEl = document.getElementById('inspectionStatusPagination');
            if (paginationEl) {
                if (totalPages <= 1) {
                    paginationEl.innerHTML = '';
                } else {
                    var pHtml = '';
                    pHtml += '<button type="button" onclick="setInspectionStatusPage(' + (inspectionStatusPage - 1) + ')" ' + (inspectionStatusPage <= 1 ? 'disabled' : '') + ' style="padding:6px 12px;border:1px solid #dee2e6;border-radius:6px;background:#fff;cursor:pointer;">이전</button>';
                    pHtml += '<span style="padding:0 12px;color:#495057;">' + inspectionStatusPage + ' / ' + totalPages + '</span>';
                    pHtml += '<button type="button" onclick="setInspectionStatusPage(' + (inspectionStatusPage + 1) + ')" ' + (inspectionStatusPage >= totalPages ? 'disabled' : '') + ' style="padding:6px 12px;border:1px solid #dee2e6;border-radius:6px;background:#fff;cursor:pointer;">다음</button>';
                    paginationEl.innerHTML = pHtml;
                }
            }
        }
        function setInspectionStatusPage(page) {
            var totalPages = Math.max(1, Math.ceil(inspectionStatusData.length / INSPECTION_STATUS_PAGE_SIZE));
            if (page >= 1 && page <= totalPages) {
                inspectionStatusPage = page;
                renderInspectionStatusTable();
            }
        }
        function onInspectionStatusSortChange() {
            inspectionStatusPage = 1;
            renderInspectionStatusTable();
        }

        // QR 다운로드 모달 열기 (현재 필터 선택값을 모달에 동기화)
        function openQrDownloadModal() {
            const schoolSelect = document.getElementById('schoolSelect');
            const classroomSelect = document.getElementById('classroomSelect');
            const typeSelect = document.querySelector('select[name="type"]');
            const searchInput = document.getElementById('searchInput');
            const qrModalSchoolId = document.getElementById('qrModalSchoolId');
            const qrModalClassroomId = document.getElementById('qrModalClassroomId');
            const qrModalType = document.getElementById('qrModalType');
            const qrModalSearchKeyword = document.getElementById('qrModalSearchKeyword');
            if (schoolSelect && qrModalSchoolId) qrModalSchoolId.value = schoolSelect.value || '';
            if (classroomSelect && qrModalClassroomId) qrModalClassroomId.value = classroomSelect.value || '';
            if (typeSelect && qrModalType) qrModalType.value = typeSelect.value || '';
            if (searchInput && qrModalSearchKeyword) qrModalSearchKeyword.value = searchInput.value || '';
            const modal = document.getElementById('qrDownloadModal');
            if (modal) {
                modal.style.display = 'block';
            }
        }
        
        // QR 다운로드 모달 닫기
        function closeQrDownloadModal() {
            const modal = document.getElementById('qrDownloadModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // QR 코드 다운로드
        async function downloadQrCode() {
            const schoolId = document.getElementById('qrModalSchoolId').value;
            if (!schoolId) {
                alert('학교를 선택해주세요.');
                return;
            }
            
            const infoLines = [];
            for (let i = 1; i <= 4; i++) {
                const select = document.getElementById('qrInfoLine' + i);
                if (select) {
                    infoLines.push(select.value);
                }
            }
            
            const type = document.getElementById('qrModalType').value || null;
            const classroomId = document.getElementById('qrModalClassroomId').value || null;
            const searchKeyword = document.getElementById('qrModalSearchKeyword').value || null;
            
            const formData = new FormData();
            formData.append('schoolId', schoolId);
            if (type) formData.append('type', type);
            if (classroomId) formData.append('classroomId', classroomId);
            if (searchKeyword) formData.append('searchKeyword', searchKeyword);
            infoLines.forEach(line => formData.append('infoLines', line));
            
            try {
                const response = await fetch('/qr-code/download-filtered', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('서버에서 파일을 생성하지 못했습니다.');
                }
                
                const blob = await response.blob();
                let filename = 'qr_code.xlsx';
                const disposition = response.headers.get('Content-Disposition');
                if (disposition) {
                    const match = disposition.match(/filename\*=UTF-8''([^;]+)/) || disposition.match(/filename="?([^\";]+)"?/);
                    if (match && match[1]) {
                        filename = decodeURIComponent(match[1]);
                    }
                }
                
                const url = window.URL.createObjectURL(blob);
                const anchor = document.createElement('a');
                anchor.href = url;
                anchor.download = filename;
                document.body.appendChild(anchor);
                anchor.click();
                anchor.remove();
                window.URL.revokeObjectURL(url);
                
                closeQrDownloadModal();
            } catch (error) {
                console.error(error);
                alert('QR 코드 엑셀 생성 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.');
            }
        }
        
        // 데이터 다운로드
        async function downloadQrData() {
            const schoolId = document.getElementById('qrModalSchoolId').value;
            if (!schoolId) {
                alert('학교를 선택해주세요.');
                return;
            }
            
            const infoLines = [];
            for (let i = 1; i <= 4; i++) {
                const select = document.getElementById('qrInfoLine' + i);
                if (select) {
                    infoLines.push(select.value);
                }
            }
            
            const type = document.getElementById('qrModalType').value || null;
            const classroomId = document.getElementById('qrModalClassroomId').value || null;
            const searchKeyword = document.getElementById('qrModalSearchKeyword').value || null;
            
            const formData = new FormData();
            formData.append('schoolId', schoolId);
            if (type) formData.append('type', type);
            if (classroomId) formData.append('classroomId', classroomId);
            if (searchKeyword) formData.append('searchKeyword', searchKeyword);
            infoLines.forEach(line => formData.append('infoLines', line));
            
            try {
                const response = await fetch('/qr-code/download-data-filtered', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('서버에서 파일을 생성하지 못했습니다.');
                }
                
                const blob = await response.blob();
                let filename = 'data.xlsx';
                const disposition = response.headers.get('Content-Disposition');
                if (disposition) {
                    const match = disposition.match(/filename\*=UTF-8''([^;]+)/) || disposition.match(/filename="?([^\";]+)"?/);
                    if (match && match[1]) {
                        filename = decodeURIComponent(match[1]);
                    }
                }
                
                const url = window.URL.createObjectURL(blob);
                const anchor = document.createElement('a');
                anchor.href = url;
                anchor.download = filename;
                document.body.appendChild(anchor);
                anchor.click();
                anchor.remove();
                window.URL.revokeObjectURL(url);
                
                closeQrDownloadModal();
            } catch (error) {
                console.error(error);
                alert('데이터 엑셀 생성 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.');
            }
        }
        
        // 모달 외부 클릭 시 닫기
        window.onclick = function(event) {
            var qrModal = document.getElementById('qrDownloadModal');
            var inspModal = document.getElementById('inspectionStatusModal');
            if (event.target == qrModal) closeQrDownloadModal();
            if (event.target == inspModal) closeInspectionStatusModal();
        }
    </script>
    
    <!-- QR 다운로드 모달 -->
    <div id="qrDownloadModal" class="qr-modal" style="display: none;">
        <div class="qr-modal-content">
            <div class="qr-modal-header">
                <h2>QR 라벨 구성</h2>
                <span class="qr-modal-close" onclick="closeQrDownloadModal()">&times;</span>
            </div>
            <div class="qr-modal-body">
                <p style="margin-bottom: 20px; color: #6c757d; font-size: 14px;">
                    엑셀에서 QR 코드 오른쪽에 표시할 정보를 선택하세요. 표시하지 않을 행은 "표시하지 않음"을 선택하면 됩니다.
                </p>
                <div class="qr-info-grid">
                    <div class="qr-info-item">
                        <label for="qrInfoLine1">1행</label>
                        <select id="qrInfoLine1" class="qr-info-select">
                            <option value="UID" selected>고유번호</option>
                            <option value="MANAGE">관리번호</option>
                            <option value="MANUFACTURER">제조사</option>
                            <option value="MODEL">모델명</option>
                            <option value="PURCHASE_DATE">도입년월</option>
                            <option value="IP">비고</option>
                            <option value="NONE">표시하지 않음</option>
                        </select>
                    </div>
                    <div class="qr-info-item">
                        <label for="qrInfoLine2">2행</label>
                        <select id="qrInfoLine2" class="qr-info-select">
                            <option value="MANAGE" selected>관리번호</option>
                            <option value="UID">고유번호</option>
                            <option value="MANUFACTURER">제조사</option>
                            <option value="MODEL">모델명</option>
                            <option value="PURCHASE_DATE">도입년월</option>
                            <option value="IP">비고</option>
                            <option value="NONE">표시하지 않음</option>
                        </select>
                    </div>
                    <div class="qr-info-item">
                        <label for="qrInfoLine3">3행</label>
                        <select id="qrInfoLine3" class="qr-info-select">
                            <option value="PURCHASE_DATE" selected>도입년월</option>
                            <option value="UID">고유번호</option>
                            <option value="MANAGE">관리번호</option>
                            <option value="MANUFACTURER">제조사</option>
                            <option value="MODEL">모델명</option>
                            <option value="IP">비고</option>
                            <option value="NONE">표시하지 않음</option>
                        </select>
                    </div>
                    <div class="qr-info-item">
                        <label for="qrInfoLine4">4행</label>
                        <select id="qrInfoLine4" class="qr-info-select">
                            <option value="IP" selected>비고</option>
                            <option value="UID">고유번호</option>
                            <option value="MANAGE">관리번호</option>
                            <option value="MANUFACTURER">제조사</option>
                            <option value="MODEL">모델명</option>
                            <option value="PURCHASE_DATE">도입년월</option>
                            <option value="NONE">표시하지 않음</option>
                        </select>
                    </div>
                </div>
                <input type="hidden" id="qrModalSchoolId" th:value="${selectedSchoolId}">
                <input type="hidden" id="qrModalType" th:value="${selectedType}">
                <input type="hidden" id="qrModalClassroomId" th:value="${selectedClassroomId}">
                <input type="hidden" id="qrModalSearchKeyword" th:value="${searchKeyword}">
            </div>
            <div class="qr-modal-footer">
                <button class="qr-download-btn" onclick="downloadQrCode()">
                    <i class="fas fa-download"></i> QR코드 다운
                </button>
                <button class="qr-download-btn" onclick="downloadQrData()">
                    <i class="fas fa-download"></i> 데이터 다운
                </button>
            </div>
        </div>
    </div>

    <!-- 검사현황 모달 -->
    <div id="inspectionStatusModal" class="qr-modal" style="display: none;">
        <div class="qr-modal-content">
            <div class="qr-modal-header">
                <h2>검사현황</h2>
                <span class="qr-modal-close" onclick="closeInspectionStatusModal()">&times;</span>
            </div>
            <div class="qr-modal-body">
                <div style="margin-bottom: 16px; display: flex; align-items: center; gap: 12px;">
                    <label for="inspectionStatusSortSelect" style="font-weight: 600; color: #495057;">정렬:</label>
                    <select id="inspectionStatusSortSelect" onchange="onInspectionStatusSortChange()" style="padding: 8px 12px; border-radius: 8px; border: 2px solid #e9ecef;">
                        <option value="classroom">기본 교실순</option>
                        <option value="status">검사현황순</option>
                    </select>
                </div>
                <div style="overflow-x: auto;">
                    <table class="inspection-status-table" style="margin: 0;">
                        <thead>
                            <tr>
                                <th>교실명</th>
                                <th>장비수</th>
                                <th>검사체크</th>
                                <th>상태</th>
                            </tr>
                        </thead>
                        <tbody id="inspectionStatusTableBody">
                            <tr><td colspan="4" style="text-align:center;color:#6c757d;">로딩 중...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="inspectionStatusPagination" style="margin-top: 12px; display: flex; justify-content: center; align-items: center; gap: 8px; flex-wrap: wrap;"></div>
            </div>
        </div>
    </div>
    <style>
        .inspection-status-dot { display: inline-block; width: 14px; height: 14px; border-radius: 50%; }
        .inspection-status-number { font-size: 1.1em; }
        .inspection-status-table { width: 100%; border-collapse: collapse; }
        .inspection-status-table th { background-color: #1e3a8a; color: white; padding: 10px 12px; text-align: center; }
        .inspection-status-table td { padding: 10px 12px; text-align: center; border-bottom: 1px solid #e5e7eb; }
        .inspection-status-dot.status-red { background-color: #dc2626; }
        .inspection-status-dot.status-orange { background-color: #f59e0b; }
        .inspection-status-dot.status-green { background-color: #22c55e; }
        /* QR 다운로드 모달 스타일 */
        .qr-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .qr-modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border: none;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .qr-modal-header {
            padding: 20px 30px;
            background-color: white;
            border-bottom: 1px solid #e9ecef;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .qr-modal-header h2 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
            color: #495057;
        }
        
        .qr-modal-close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        
        .qr-modal-close:hover,
        .qr-modal-close:focus {
            color: #000;
        }
        
        .qr-modal-body {
            padding: 30px;
        }
        
        .qr-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        
        .qr-info-item {
            display: flex;
            flex-direction: column;
        }
        
        .qr-info-item label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .qr-info-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            color: #495057;
            background-color: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        .qr-info-select:focus {
            outline: none;
            border-color: #6f42c1;
        }
        
        .qr-modal-footer {
            padding: 20px 30px;
            background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
            border-radius: 0 0 12px 12px;
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .qr-download-btn {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(111, 66, 193, 0.3);
        }
        
        .qr-download-btn:hover {
            background: linear-gradient(135deg, #5a32a3 0%, #4a2a8a 100%);
            box-shadow: 0 4px 12px rgba(111, 66, 193, 0.4);
            transform: translateY(-1px);
        }
        
        .qr-download-btn:active {
            transform: translateY(0);
        }
        
        @media (max-width: 600px) {
            .qr-info-grid {
                grid-template-columns: 1fr;
            }
            
            .qr-modal-footer {
                flex-direction: column;
            }
            
            .qr-download-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
    
    <!-- QR 스캔 모달 (카메라로 QR 코드 스캔 후 바로 검색) -->
    <div id="qrScanModal">
        <div class="qr-scan-modal-content">
            <video id="qrScanVideo" playsinline muted></video>
            <canvas id="qrScanCanvas"></canvas>
            <p class="qr-scan-msg">QR 코드를 카메라에 맞춰 주세요</p>
            <button type="button" class="qr-scan-close" id="qrScanClose">닫기</button>
        </div>
    </div>
    
    <!-- 엑셀 다운로드 로딩 오버레이 -->
    <div id="excelLoadingOverlay" class="excel-loading-overlay">
        <div class="excel-loading-content">
            <i class="fas fa-spinner fa-spin"></i>
            <span>엑셀 다운로드 중</span>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js"></script>
    <script>
    (function() {
        var qrScanModal = document.getElementById('qrScanModal');
        var qrScanVideo = document.getElementById('qrScanVideo');
        var qrScanCanvas = document.getElementById('qrScanCanvas');
        var qrScanBtn = document.getElementById('qrScanBtn');
        var qrScanClose = document.getElementById('qrScanClose');
        var stream = null;
        var animationId = null;
        var barcodeDetector = null;
        var barcodeDetectorFrameCount = 0;
        try {
            if ('BarcodeDetector' in window) {
                barcodeDetector = new BarcodeDetector({ formats: ['qr_code'] });
            }
        } catch (e) {}
        
        function stopQrScan() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            if (stream && stream.getTracks) {
                stream.getTracks().forEach(function(t) { t.stop(); });
                stream = null;
            }
            if (qrScanVideo && qrScanVideo.srcObject) {
                qrScanVideo.srcObject = null;
            }
            if (qrScanModal) qrScanModal.classList.remove('show');
        }
        
        function applySearchAndClose(keyword) {
            var searchInput = document.getElementById('searchInput');
            var filterForm = document.getElementById('filterForm');
            if (searchInput) searchInput.value = keyword || '';
            if (filterForm) {
                var hiddenKw = filterForm.querySelector('[name="searchKeyword"]');
                if (hiddenKw) hiddenKw.value = keyword || '';
            }
            stopQrScan();
            if (typeof loadDeviceListApi === 'function') loadDeviceListApi(1);
        }
        
        function tick() {
            if (!qrScanVideo || qrScanVideo.readyState !== qrScanVideo.HAVE_ENOUGH_DATA || !qrScanCanvas) {
                animationId = requestAnimationFrame(tick);
                return;
            }
            var w = qrScanVideo.videoWidth;
            var h = qrScanVideo.videoHeight;
            if (!w || !h) {
                animationId = requestAnimationFrame(tick);
                return;
            }
            qrScanCanvas.width = w;
            qrScanCanvas.height = h;
            var ctx = qrScanCanvas.getContext('2d');
            ctx.drawImage(qrScanVideo, 0, 0, w, h);
            var found = false;
            if (barcodeDetector && (barcodeDetectorFrameCount++ % 6 === 0)) {
                barcodeDetector.detect(qrScanVideo).then(function(rs) {
                    if (rs && rs.length && rs[0].rawValue) applySearchAndClose(rs[0].rawValue);
                }).catch(function() {});
            }
            if (typeof jsQR !== 'undefined') {
                var imageData = ctx.getImageData(0, 0, w, h);
                var result = jsQR(imageData.data, w, h, { inversionAttempts: 'attemptBoth' });
                if (result && result.data) {
                    applySearchAndClose(result.data);
                    return;
                }
            }
            animationId = requestAnimationFrame(tick);
        }
        
        if (qrScanBtn) {
            qrScanBtn.addEventListener('click', function() {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    alert('이 브라우저에서는 카메라를 사용할 수 없습니다. HTTPS 환경에서 접속해 주세요.');
                    return;
                }
                if (!qrScanModal || !qrScanVideo || !qrScanCanvas) return;
                qrScanModal.classList.add('show');
                barcodeDetectorFrameCount = 0;
                var constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920, min: 1280 },
                        height: { ideal: 1080, min: 720 }
                    }
                };
                navigator.mediaDevices.getUserMedia(constraints).then(function(s) {
                    stream = s;
                    qrScanVideo.srcObject = s;
                    qrScanVideo.setAttribute('playsinline', true);
                    qrScanVideo.play().then(function() {
                        tick();
                    }).catch(function() {
                        tick();
                    });
                }).catch(function(err) {
                    constraints.video = { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } };
                    return navigator.mediaDevices.getUserMedia(constraints);
                }).then(function(s) {
                    if (!stream) {
                        stream = s;
                        qrScanVideo.srcObject = s;
                        qrScanVideo.setAttribute('playsinline', true);
                        qrScanVideo.play().then(function() { tick(); }).catch(function() { tick(); });
                    }
                }).catch(function(err) {
                    stopQrScan();
                    alert('카메라에 접근할 수 없습니다. 권한을 허용해 주세요.');
                });
            });
        }
        if (qrScanClose) qrScanClose.addEventListener('click', stopQrScan);
        if (qrScanModal) {
            qrScanModal.addEventListener('click', function(e) {
                if (e.target === qrScanModal) stopQrScan();
            });
        }
    })();
    </script>
    
</body>
</html> 